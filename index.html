<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tyler Street-Level Traffic Simulation</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        :root {
            --bg: #0b0b0e;
            --panel: #16161a;
            --accent: #3b82f6;
            --critical: #ef4444;
            --heavy: #f59e0b;
            --flow: #10b981;
            --text: #ffffff;
        }

        body, html { margin: 0; padding: 0; height: 100%; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg); color: var(--text); overflow: hidden; }

        #container { display: flex; flex-direction: column; height: 100vh; }

        header {
            height: 65px; background: #111114; border-bottom: 1px solid #2d2d35;
            display: flex; align-items: center; padding: 0 25px; justify-content: space-between; z-index: 1000;
        }

        .logo { font-weight: 800; font-size: 1.1rem; letter-spacing: 1px; color: var(--accent); }
        .logo span { color: #888; font-weight: 400; font-size: 0.8rem; margin-left: 10px; }

        .dept-filters { display: flex; gap: 10px; }
        .filter-btn {
            background: #25252b; border: 1px solid #3f3f46; color: #a1a1aa;
            padding: 8px 16px; border-radius: 5px; cursor: pointer; font-size: 0.75rem; font-weight: 600;
            transition: all 0.2s;
        }
        .filter-btn.active { background: var(--accent); color: white; border-color: var(--accent); box-shadow: 0 0 10px rgba(59, 130, 246, 0.4); }

        #workspace { display: flex; flex: 1; overflow: hidden; }
        #map { flex: 1; background: #000; }

        #incident-panel {
            width: 380px; background: var(--panel); border-left: 1px solid #2d2d35;
            display: flex; flex-direction: column;
        }

        .panel-title { padding: 20px; font-size: 0.85rem; font-weight: 700; border-bottom: 1px solid #2d2d35; display: flex; justify-content: space-between; }
        .timer-label { color: var(--accent); font-family: monospace; }

        #feed { flex: 1; overflow-y: auto; padding: 15px; }
        
        .incident-card {
            background: #1f1f25; border-radius: 6px; padding: 15px; margin-bottom: 12px;
            border-left: 4px solid #444; animation: slideIn 0.3s ease-out;
        }
        .incident-card.high { border-left-color: var(--critical); }
        .incident-card.med { border-left-color: var(--heavy); }
        .incident-card.low { border-left-color: var(--flow); }
        .incident-card.hidden { display: none; }

        .card-row { display: flex; justify-content: space-between; margin-bottom: 5px; }
        .street-name { font-weight: 700; font-size: 0.9rem; color: #fff; }
        .timestamp { font-size: 0.7rem; color: #71717a; }
        .incident-desc { font-size: 0.8rem; color: #d1d1d6; margin: 8px 0; }
        .dept-pills { display: flex; gap: 5px; }
        .pill { font-size: 0.6rem; background: #2d2d35; padding: 2px 6px; border-radius: 3px; color: #a1a1aa; text-transform: uppercase; }

        .waze-icon {
            width: 32px; height: 32px; border-radius: 50%; border: 2px solid #fff;
            display: flex; align-items: center; justify-content: center; font-size: 16px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.5); font-weight: bold;
        }

        @keyframes slideIn { from { opacity: 0; transform: translateX(20px); } to { opacity: 1; transform: translateX(0); } }
    </style>
</head>
<body>

<div id="container">
    <header>
        <div class="logo">TYLER_STREET_NET <span>V4.0 PRECISION SIM</span></div>
        <div class="dept-filters">
            <button class="filter-btn active" onclick="filterDept('ALL')">City Wide</button>
            <button class="filter-btn" onclick="filterDept('PD')">Police</button>
            <button class="filter-btn" onclick="filterDept('FIRE')">Fire</button>
            <button class="filter-btn" onclick="filterDept('ENG')">Traffic Eng</button>
        </div>
    </header>

    <div id="workspace">
        <div id="map"></div>
        <div id="incident-panel">
            <div class="panel-title">
                LIVE STREET REPORTS
                <span id="timer" class="timer-label">01:30</span>
            </div>
            <div id="feed"></div>
        </div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    const SIM_INTERVAL = 90000; // 1.5 Minutes
    let map, activeAlerts = [], currentDept = 'ALL', secondsLeft = 90;

    // Accurate Tyler Road Segments
    const STREET_NETWORK = [
        // Broadway Segments
        { id: "bway_n", name: "N Broadway Ave (Gentry to Downtown)", path: [[32.400, -95.301], [32.351, -95.301]] },
        { id: "bway_s", name: "S Broadway Ave (Downtown to Loop)", path: [[32.351, -95.301], [32.308, -95.302]] },
        { id: "bway_ext", name: "S Broadway Ave (Loop to Grande)", path: [[32.308, -95.302], [32.280, -95.302]] },
        // Loop 323 Segments
        { id: "loop_nw", name: "NW Loop 323", path: [[32.384, -95.341], [32.402, -95.301]] },
        { id: "loop_ne", name: "NE Loop 323", path: [[32.402, -95.301], [32.384, -95.260]] },
        { id: "loop_sw", name: "SW Loop 323", path: [[32.308, -95.340], [32.315, -95.370]] },
        { id: "loop_se", name: "SE Loop 323", path: [[32.308, -95.260], [32.316, -95.235]] },
        // HWY 31 Segments
        { id: "hwy31_w", name: "W Front St (Hwy 31)", path: [[32.351, -95.301], [32.352, -95.370]] },
        { id: "hwy31_e", name: "E Front St (Hwy 31)", path: [[32.351, -95.301], [32.350, -95.230]] },
        // Troup Hwy
        { id: "troup_1", name: "Troup Hwy (Beckham to Loop)", path: [[32.340, -95.285], [32.316, -95.255]] },
        // Old Jacksonville
        { id: "old_jax", name: "Old Jacksonville Hwy", path: [[32.328, -95.315], [32.290, -95.345]] }
    ];

    const INCIDENT_TYPES = [
        { type: "Major Collision", icon: "ðŸ’¥", depts: ["PD", "FIRE"], severity: "high" },
        { type: "Stalled Vehicle", icon: "ðŸš—", depts: ["PD"], severity: "low" },
        { type: "Traffic Light Out", icon: "ðŸš¦", depts: ["ENG"], severity: "high" },
        { type: "Road Construction", icon: "ðŸš§", depts: ["ENG"], severity: "med" },
        { type: "Heavy Backup", icon: "ðŸ›‘", depts: ["PD", "ENG"], severity: "med" }
    ];

    function init() {
        map = L.map('map', { zoomControl: false, center: [32.345, -95.301], zoom: 13 });
        
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);

        // Render Street Network
        STREET_NETWORK.forEach(street => {
            street.layer = L.polyline(street.path, {
                color: '#10b981', weight: 6, opacity: 0.8, lineCap: 'round'
            }).addTo(map);
            street.layer.bindPopup(`<b>${street.name}</b>`);
        });

        runSimulation();
        setInterval(runSimulation, SIM_INTERVAL);
        setInterval(updateTimer, 1000);
    }

    function runSimulation() {
        secondsLeft = 90;

        // 1. Update Segment Congestion
        STREET_NETWORK.forEach(street => {
            const roll = Math.random();
            let color = '#10b981'; // Flowing
            if (roll > 0.85) color = '#ef4444'; // Gridlock
            else if (roll > 0.65) color = '#f59e0b'; // Heavy
            
            street.layer.setStyle({ color: color });
        });

        // 2. Clear Old Incidents
        activeAlerts.forEach(a => map.removeLayer(a.marker));
        activeAlerts = [];
        document.getElementById('feed').innerHTML = '';

        // 3. Generate 2-3 New Accurate Incidents
        for(let i=0; i < (Math.floor(Math.random() * 2) + 2); i++) {
            createIncident();
        }
    }

    function createIncident() {
        const street = STREET_NETWORK[Math.floor(Math.random() * STREET_NETWORK.length)];
        const config = INCIDENT_TYPES[Math.floor(Math.random() * INCIDENT_TYPES.length)];
        
        // Accurate Placement: Randomly pick start or end of the segment
        const pos = street.path[Math.random() > 0.5 ? 0 : 1];
        
        const color = config.severity === 'high' ? '#ef4444' : (config.severity === 'med' ? '#f59e0b' : '#3b82f6');
        
        const icon = L.divIcon({
            className: '',
            html: `<div class="waze-icon" style="background:${color}">${config.icon}</div>`,
            iconSize: [32, 32]
        });

        const marker = L.marker(pos, { icon: icon }).bindPopup(`<b>${config.type}</b><br>${street.name}`);
        
        const card = document.createElement('div');
        card.className = `incident-card ${config.severity}`;
        card.innerHTML = `
            <div class="card-row">
                <span class="street-name">${street.name}</span>
                <span class="timestamp">${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
            </div>
            <div class="incident-desc">${config.icon} ${config.type} reported on this segment.</div>
            <div class="dept-pills">
                ${config.depts.map(d => `<span class="pill">${d}</span>`).join('')}
            </div>
        `;

        const alertObj = { marker, depts: config.depts, element: card };
        activeAlerts.push(alertObj);

        document.getElementById('feed').appendChild(card);
        syncVisibility(alertObj);
    }

    function syncVisibility(alert) {
        const isVisible = currentDept === 'ALL' || alert.depts.includes(currentDept);
        if (isVisible) {
            alert.marker.addTo(map);
            alert.element.classList.remove('hidden');
        } else {
            map.removeLayer(alert.marker);
            alert.element.classList.add('hidden');
        }
    }

    function filterDept(dept) {
        currentDept = dept;
        document.querySelectorAll('.filter-btn').forEach(b => {
            b.classList.toggle('active', b.innerText.includes(dept) || (dept === 'ALL' && b.innerText === 'City Wide'));
        });
        activeAlerts.forEach(syncVisibility);
    }

    function updateTimer() {
        secondsLeft--;
        if (secondsLeft < 0) secondsLeft = 0;
        const mins = Math.floor(secondsLeft / 60);
        const secs = secondsLeft % 60;
        document.getElementById('timer').innerText = 
            `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    }

    window.onload = init;
</script>
</body>
</html>
