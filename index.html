<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Tyler, TX Traffic Simulation Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    crossorigin=""
  ></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root {
      --bg: #0f172a;
      --bg-alt: #111827;
      --panel-bg: #020617;
      --accent: #38bdf8;
      --accent-soft: rgba(56, 189, 248, 0.15);
      --text: #e5e7eb;
      --muted: #9ca3af;
      --danger: #ef4444;
      --warning: #f97316;
      --success: #22c55e;
      --border: #1f2933;
      --badge-bg: #1e293b;
      --badge-border: #334155;
      --scrollbar: #4b5563;
      --scrollbar-bg: #020617;
    }

    * {
      box-sizing: border-box;
    }

    html,
    body {
      margin: 0;
      padding: 0;
      height: 100%;
      width: 100%;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
        "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #020617 0, #020617 40%, #020617 100%);
      color: var(--text);
      overflow: hidden;
    }

    body {
      display: flex;
      flex-direction: column;
    }

    /* Top bar */
    #top-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 18px;
      background: linear-gradient(90deg, #020617, #020617 40%, #020617 100%);
      border-bottom: 1px solid var(--border);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.6);
      z-index: 1000;
    }

    #top-bar-left {
      display: flex;
      align-items: center;
      gap: 14px;
    }

    #app-title {
      font-size: 18px;
      font-weight: 600;
      letter-spacing: 0.04em;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    #app-title span.logo-dot {
      width: 10px;
      height: 10px;
      border-radius: 999px;
      background: radial-gradient(circle, #38bdf8, #0ea5e9);
      box-shadow: 0 0 12px rgba(56, 189, 248, 0.9);
    }

    #app-subtitle {
      font-size: 11px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.16em;
    }

    #top-bar-right {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .pill-group {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 4px 8px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(51, 65, 85, 0.9);
    }

    .pill-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--muted);
    }

    .pill-toggle {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid transparent;
      background: rgba(15, 23, 42, 0.9);
      color: var(--muted);
      font-size: 11px;
      cursor: pointer;
      transition: all 0.15s ease-out;
    }

    .pill-toggle.active {
      background: radial-gradient(circle at top left, #22c55e, #16a34a);
      color: #ecfdf5;
      border-color: rgba(34, 197, 94, 0.8);
      box-shadow: 0 0 12px rgba(34, 197, 94, 0.7);
    }

    .pill-toggle span.dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: rgba(148, 163, 184, 0.8);
    }

    .pill-toggle.active span.dot {
      background: #bbf7d0;
    }

    .status-indicator {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      background: rgba(15, 23, 42, 0.9);
      font-size: 11px;
      color: var(--muted);
    }

    .status-indicator span.dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 10px rgba(34, 197, 94, 0.8);
    }

    .status-indicator strong {
      font-weight: 500;
      color: #e5e7eb;
    }

    .status-indicator small {
      font-size: 10px;
      color: var(--muted);
    }

    /* Main layout */
    #main {
      flex: 1;
      display: grid;
      grid-template-columns: minmax(0, 2.2fr) minmax(320px, 1fr);
      height: calc(100% - 52px);
      background: radial-gradient(circle at top left, #020617 0, #020617 40%, #020617 100%);
    }

    #map-container {
      position: relative;
      padding: 10px 10px 10px 18px;
    }

    #map {
      width: 100%;
      height: 100%;
      border-radius: 18px;
      border: 1px solid var(--border);
      box-shadow: 0 18px 40px rgba(0, 0, 0, 0.7);
      background: #020617;
    }

    /* Right panel */
    #right-panel {
      padding: 10px 18px 10px 10px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .panel {
      background: radial-gradient(circle at top left, #020617 0, #020617 40%, #020617 100%);
      border-radius: 18px;
      border: 1px solid var(--border);
      box-shadow: 0 18px 40px rgba(0, 0, 0, 0.7);
      padding: 12px 14px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      height: 100%;
    }

    .panel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    .panel-title {
      font-size: 13px;
      font-weight: 500;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--muted);
    }

    .panel-badges {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .badge {
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid var(--badge-border);
      background: var(--badge-bg);
      font-size: 10px;
      color: var(--muted);
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .badge-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: var(--accent);
    }

    .badge-dot.alerts {
      background: #f97316;
    }

    .badge-dot.weather {
      background: #22c55e;
    }

    /* Department filters */
    #dept-filters {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .dept-chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid rgba(51, 65, 85, 0.9);
      background: rgba(15, 23, 42, 0.9);
      font-size: 11px;
      color: var(--muted);
      cursor: pointer;
      transition: all 0.15s ease-out;
    }

    .dept-chip.active {
      color: #e5e7eb;
      border-color: rgba(148, 163, 184, 0.9);
      box-shadow: 0 0 10px rgba(15, 23, 42, 0.9);
      background: radial-gradient(circle at top left, #1f2937, #020617);
    }

    .dept-chip span.dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
    }

    .dept-chip[data-dept="PD"] span.dot {
      background: #38bdf8;
    }

    .dept-chip[data-dept="Fire"] span.dot {
      background: #f97316;
    }

    .dept-chip[data-dept="Traffic"] span.dot {
      background: #a855f7;
    }

    .dept-chip[data-dept="Streets"] span.dot {
      background: #22c55e;
    }

    .dept-chip[data-dept="Engineering"] span.dot {
      background: #eab308;
    }

    /* Tabs */
    .tabs {
      display: flex;
      gap: 6px;
      border-bottom: 1px solid var(--border);
      padding-bottom: 4px;
    }

    .tab-button {
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid transparent;
      background: transparent;
      color: var(--muted);
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      cursor: pointer;
      transition: all 0.15s ease-out;
    }

    .tab-button.active {
      background: radial-gradient(circle at top left, #1f2937, #020617);
      border-color: rgba(148, 163, 184, 0.9);
      color: #e5e7eb;
    }

    .tab-content {
      flex: 1;
      display: none;
      margin-top: 6px;
    }

    .tab-content.active {
      display: flex;
      flex-direction: column;
    }

    /* Reports list */
    #reports-list {
      flex: 1;
      overflow-y: auto;
      padding-right: 4px;
    }

    #reports-list::-webkit-scrollbar {
      width: 6px;
    }

    #reports-list::-webkit-scrollbar-track {
      background: var(--scrollbar-bg);
    }

    #reports-list::-webkit-scrollbar-thumb {
      background: var(--scrollbar);
      border-radius: 999px;
    }

    .report-item {
      padding: 8px 8px;
      border-radius: 10px;
      border: 1px solid rgba(31, 41, 55, 0.9);
      background: radial-gradient(circle at top left, #020617 0, #020617 40%, #020617 100%);
      margin-bottom: 6px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .report-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 6px;
    }

    .report-type {
      font-size: 11px;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.12em;
    }

    .report-type span {
      opacity: 0.8;
    }

    .report-corridor {
      font-size: 12px;
      color: var(--text);
    }

    .report-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      font-size: 10px;
      color: var(--muted);
    }

    .report-meta span {
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .severity-pill {
      padding: 2px 6px;
      border-radius: 999px;
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .severity-low {
      background: rgba(34, 197, 94, 0.12);
      color: #4ade80;
      border: 1px solid rgba(34, 197, 94, 0.4);
    }

    .severity-med {
      background: rgba(234, 179, 8, 0.12);
      color: #facc15;
      border: 1px solid rgba(234, 179, 8, 0.4);
    }

    .severity-high {
      background: rgba(249, 115, 22, 0.12);
      color: #fb923c;
      border: 1px solid rgba(249, 115, 22, 0.4);
    }

    .severity-critical {
      background: rgba(239, 68, 68, 0.12);
      color: #fca5a5;
      border: 1px solid rgba(239, 68, 68, 0.4);
    }

    .report-body {
      font-size: 11px;
      color: var(--muted);
    }

    .report-footer {
      display: flex;
      justify-content: space-between;
      font-size: 10px;
      color: var(--muted);
    }

    .report-depts {
      display: inline-flex;
      gap: 4px;
    }

    .report-dept-pill {
      padding: 1px 6px;
      border-radius: 999px;
      border: 1px solid rgba(51, 65, 85, 0.9);
      background: rgba(15, 23, 42, 0.9);
      font-size: 9px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    /* Graph tab */
    #graphs-container {
      display: flex;
      flex-direction: column;
      gap: 8px;
      height: 100%;
    }

    #corridor-select {
      width: 100%;
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: #020617;
      color: #e5e7eb;
      font-size: 12px;
    }

    #chart-wrapper {
      flex: 1;
      min-height: 0;
    }

    #corridor-chart {
      width: 100%;
      height: 100%;
    }

    /* Small screen */
    @media (max-width: 900px) {
      #main {
        grid-template-columns: 1fr;
        grid-template-rows: 1.4fr 1.2fr;
      }

      #right-panel {
        padding: 0 10px 10px 10px;
      }

      #map-container {
        padding: 10px;
      }
    }
  </style>
</head>

<body>
  <div id="top-bar">
    <div id="top-bar-left">
      <div>
        <div id="app-title">
          <span class="logo-dot"></span>
          Tyler Traffic Simulation
        </div>
        <div id="app-subtitle">
          Citywide congestion · incidents · weather · PD / Fire / Traffic / Streets / Engineering
        </div>
      </div>
      <div id="dept-filters">
        <div class="dept-chip active" data-dept="PD">
          <span class="dot"></span> PD
        </div>
        <div class="dept-chip active" data-dept="Fire">
          <span class="dot"></span> Fire
        </div>
        <div class="dept-chip active" data-dept="Traffic">
          <span class="dot"></span> Traffic
        </div>
        <div class="dept-chip active" data-dept="Streets">
          <span class="dot"></span> Streets
        </div>
        <div class="dept-chip active" data-dept="Engineering">
          <span class="dot"></span> Eng
        </div>
      </div>
    </div>

    <div id="top-bar-right">
      <div class="pill-group">
        <div class="pill-label">Weather</div>
        <button id="weather-toggle" class="pill-toggle active">
          <span class="dot"></span> Radar On
        </button>
      </div>
      <div class="pill-group">
        <div class="pill-label">Simulation</div>
        <div id="sim-status" class="status-indicator">
          <span class="dot"></span>
          <div>
            <strong>Running</strong><br />
            <small id="sim-countdown">Next tick in 90s</small>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="main">
    <div id="map-container">
      <div id="map"></div>
    </div>
    <div id="right-panel">
      <div class="panel">
        <div class="panel-header">
          <div class="panel-title">Citywide situational view</div>
          <div class="panel-badges">
            <div class="badge">
              <span class="badge-dot alerts"></span> Alerts
            </div>
            <div class="badge">
              <span class="badge-dot weather"></span> Weather
            </div>
          </div>
        </div>

        <div class="tabs">
          <button class="tab-button active" data-tab="alerts-tab">Alerts & Reports</button>
          <button class="tab-button" data-tab="graphs-tab">Corridor Congestion</button>
        </div>

        <div id="alerts-tab" class="tab-content active">
          <div id="reports-list"></div>
        </div>

        <div id="graphs-tab" class="tab-content">
          <div id="graphs-container">
            <select id="corridor-select"></select>
            <div id="chart-wrapper">
              <canvas id="corridor-chart"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    /************************************************************
     * CORE CONFIG
     ************************************************************/
    const SIM_TICK_SECONDS = 90;
    const BASE_CENTER = [32.35, -95.30]; // Tyler approx
    const ACTIVE_DEPARTMENTS = new Set(["PD", "Fire", "Traffic", "Streets", "Engineering"]);
    let weatherEnabled = true;
    let simCountdown = SIM_TICK_SECONDS;
    let simInterval = null;
    let countdownInterval = null;
    const MAX_HISTORY_POINTS = 120;

    /************************************************************
     * ALERT TYPES / COLORS / DEPARTMENTS
     ************************************************************/
    const ALERT_TYPES = [
      "Police",
      "Speed Trap",
      "Traffic Stop",
      "Crash",
      "Severe Crash",
      "Pile-up",
      "Closure",
      "Construction / Utility",
      "Debris",
      "Pothole",
      "Blocked Lane",
      "Stopped Vehicle",
      "Vehicle on Shoulder",
      "Fire / EMS",
      "Bad Road Condition",
      "Weather Alert"
    ];

    const ALERT_COLORS = {
      "Police": "#38bdf8",
      "Speed Trap": "#0ea5e9",
      "Traffic Stop": "#22c55e",
      "Crash": "#f97316",
      "Severe Crash": "#ef4444",
      "Pile-up": "#b91c1c",
      "Closure": "#e11d48",
      "Construction / Utility": "#facc15",
      "Debris": "#f97316",
      "Pothole": "#a855f7",
      "Blocked Lane": "#fb923c",
      "Stopped Vehicle": "#f97316",
      "Vehicle on Shoulder": "#f97316",
      "Fire / EMS": "#f97316",
      "Bad Road Condition": "#6b7280",
      "Weather Alert": "#38bdf8"
    };

    const ALERT_DEPARTMENTS = {
      "Police": ["PD", "Traffic"],
      "Speed Trap": ["PD"],
      "Traffic Stop": ["PD", "Traffic"],
      "Crash": ["PD", "Fire", "Traffic"],
      "Severe Crash": ["PD", "Fire", "Traffic"],
      "Pile-up": ["PD", "Fire", "Traffic"],
      "Closure": ["Streets", "Engineering", "Traffic"],
      "Construction / Utility": ["Streets", "Engineering"],
      "Debris": ["Streets"],
      "Pothole": ["Streets", "Engineering"],
      "Blocked Lane": ["Traffic", "Streets"],
      "Stopped Vehicle": ["PD", "Traffic"],
      "Vehicle on Shoulder": ["PD", "Traffic"],
      "Fire / EMS": ["Fire", "PD"],
      "Bad Road Condition": ["Streets", "Engineering", "Traffic"],
      "Weather Alert": ["Traffic", "Streets", "Engineering"]
    };

    const BASE_TYPE_WEIGHTS = {
      "Police": 0.8,
      "Speed Trap": 0.5,
      "Traffic Stop": 0.7,
      "Crash": 1.0,
      "Severe Crash": 0.6,
      "Pile-up": 0.3,
      "Closure": 0.4,
      "Construction / Utility": 0.7,
      "Debris": 0.5,
      "Pothole": 0.4,
      "Blocked Lane": 0.8,
      "Stopped Vehicle": 1.2,
      "Vehicle on Shoulder": 1.0,
      "Fire / EMS": 0.3,
      "Bad Road Condition": 0.6,
      "Weather Alert": 0.2
    };

    /************************************************************
     * CORRIDORS + POIs (coords should be real OSM nodes in practice)
     * These are approximate; swap with exact intersection coords.
     ************************************************************/
    const corridors = [
      {
        name: "Broadway Ave",
        freeFlowSpeed: 40,
        departments: ["PD", "Traffic", "Streets", "Engineering"],
        confidence: 0.9,
        risk: 1.2,
        baseDemand: 1800,
        demandProfile: [0.4, 0.5, 0.8, 1.0, 0.9, 0.6, 0.4, 0.3, 0.3, 0.4, 0.6, 0.8, 1.0, 0.9, 0.7, 0.6, 0.5, 0.4, 0.3, 0.3, 0.3, 0.3, 0.3, 0.3],
        incidentProfile: {
          crashRate: 1.3,
          enforcementRate: 1.0,
          constructionRate: 1.0,
          debrisRate: 0.9
        },
        baseGeometry: [
          [32.30663, -95.30128], // Rice
          [32.31994, -95.30133], // Loop 323
          [32.33039, -95.30118], // Shiloh
          [32.35102, -95.30099], // Front
          [32.36096, -95.30107]  // Gentry
        ],
        points: [
          {
            name: "Broadway @ Rice Rd",
            coord: [32.30663, -95.30128],
            weight: 4,
            poiModifiers: { crash: 1.1, enforcement: 1.0, construction: 1.0, debris: 1.0 }
          },
          {
            name: "Broadway @ Loop 323",
            coord: [32.31994, -95.30133],
            weight: 5,
            poiModifiers: { crash: 1.4, enforcement: 1.1, construction: 1.0, debris: 1.0 }
          },
          {
            name: "Broadway @ Shiloh Rd",
            coord: [32.33039, -95.30118],
            weight: 3,
            poiModifiers: { crash: 1.2, enforcement: 1.0, construction: 1.0, debris: 1.0 }
          },
          {
            name: "Broadway @ Front St",
            coord: [32.35102, -95.30099],
            weight: 5,
            poiModifiers: { crash: 1.3, enforcement: 1.0, construction: 1.1, debris: 1.0 }
          },
          {
            name: "Broadway @ Gentry Pkwy",
            coord: [32.36096, -95.30107],
            weight: 3,
            poiModifiers: { crash: 1.2, enforcement: 1.0, construction: 1.0, debris: 1.0 }
          }
        ]
      },
      {
        name: "Loop 323 North",
        freeFlowSpeed: 45,
        departments: ["PD", "Traffic", "Streets", "Engineering"],
        confidence: 0.85,
        risk: 1.1,
        baseDemand: 2200,
        demandProfile: [0.3, 0.3, 0.4, 0.6, 0.8, 1.0, 1.1, 1.2, 1.0, 0.9, 0.8, 0.8, 0.9, 1.0, 1.1, 1.2, 1.1, 0.9, 0.7, 0.5, 0.4, 0.3, 0.3, 0.3],
        incidentProfile: {
          crashRate: 1.4,
          enforcementRate: 1.1,
          constructionRate: 1.0,
          debrisRate: 1.0
        },
        baseGeometry: [
          [32.31960, -95.33070], // Old Jacksonville
          [32.31994, -95.30133], // Broadway
          [32.35010, -95.28020], // SH-110
          [32.37520, -95.29490]  // US-271
        ],
        points: [
          {
            name: "Loop 323 @ Old Jacksonville Hwy",
            coord: [32.31960, -95.33070],
            weight: 4,
            poiModifiers: { crash: 1.3, enforcement: 1.0, construction: 1.0, debris: 1.0 }
          },
          {
            name: "Loop 323 @ Broadway",
            coord: [32.31994, -95.30133],
            weight: 5,
            poiModifiers: { crash: 1.5, enforcement: 1.1, construction: 1.0, debris: 1.0 }
          },
          {
            name: "Loop 323 @ SH-110",
            coord: [32.35010, -95.28020],
            weight: 4,
            poiModifiers: { crash: 1.4, enforcement: 1.0, construction: 1.0, debris: 1.0 }
          },
          {
            name: "Loop 323 @ US-271",
            coord: [32.37520, -95.29490],
            weight: 3,
            poiModifiers: { crash: 1.3, enforcement: 1.0, construction: 1.0, debris: 1.0 }
          }
        ]
      },
      {
        name: "SH-31 / Front St",
        freeFlowSpeed: 35,
        departments: ["PD", "Traffic", "Streets", "Engineering"],
        confidence: 0.9,
        risk: 1.0,
        baseDemand: 1600,
        demandProfile: [0.3, 0.4, 0.6, 0.8, 1.0, 1.0, 0.9, 0.8, 0.7, 0.6, 0.6, 0.7, 0.8, 0.9, 1.0, 1.0, 0.9, 0.7, 0.5, 0.4, 0.3, 0.3, 0.3, 0.3],
        incidentProfile: {
          crashRate: 1.1,
          enforcementRate: 0.9,
          constructionRate: 1.2,
          debrisRate: 1.0
        },
        baseGeometry: [
          [32.35130, -95.31010], // Palace
          [32.35102, -95.30099], // Broadway
          [32.35110, -95.29620]  // Beckham
        ],
        points: [
          {
            name: "Front St @ Palace Ave",
            coord: [32.35130, -95.31010],
            weight: 2,
            poiModifiers: { crash: 1.0, enforcement: 0.9, construction: 1.1, debris: 1.0 }
          },
          {
            name: "Front St @ Broadway",
            coord: [32.35102, -95.30099],
            weight: 5,
            poiModifiers: { crash: 1.3, enforcement: 1.0, construction: 1.2, debris: 1.0 }
          },
          {
            name: "Front St @ Beckham Ave",
            coord: [32.35110, -95.29620],
            weight: 3,
            poiModifiers: { crash: 1.1, enforcement: 0.9, construction: 1.1, debris: 1.0 }
          }
        ]
      }
    ];

    /************************************************************
     * UTILS
     ************************************************************/
    function haversineDistance(a, b) {
      const R = 6371000;
      const toRad = (d) => (d * Math.PI) / 180;
      const dLat = toRad(b[0] - a[0]);
      const dLng = toRad(b[1] - a[1]);
      const lat1 = toRad(a[0]);
      const lat2 = toRad(b[0]);
      const sinDLat = Math.sin(dLat / 2);
      const sinDLng = Math.sin(dLng / 2);
      const h = sinDLat * sinDLat + Math.cos(lat1) * Math.cos(lat2) * sinDLng * sinDLng;
      return 2 * R * Math.asin(Math.sqrt(h));
    }

    function formatTime(ts) {
      return ts.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
    }

    function severityClass(sev) {
      switch (sev) {
        case "low": return "severity-low";
        case "med": return "severity-med";
        case "high": return "severity-high";
        case "critical": return "severity-critical";
        default: return "severity-low";
      }
    }

    function severityLabel(sev) {
      switch (sev) {
        case "low": return "Low";
        case "med": return "Moderate";
        case "high": return "High";
        case "critical": return "Critical";
        default: return "Low";
      }
    }

    function confidenceLabel(c) {
      if (c >= 0.85) return "High";
      if (c >= 0.7) return "Medium";
      return "Low";
    }

    /************************************************************
     * STATE
     ************************************************************/
    let corridorState = {}; // name -> { history, lastValue }
    let alerts = [];
    let map, weatherLayerGroup, alertLayerGroup;
    let alertMarkers = [];
    let corridorChart = null;
    let selectedCorridorName = null;

    /************************************************************
     * RADAR WEATHER ENGINE
     ************************************************************/
    const RADAR_GRID_ROWS = 20;
    const RADAR_GRID_COLS = 20;
    const WEATHER_TYPES = ["Rain", "Thunderstorm", "Fog", "Ice", "Wind"];
    let radarCells = [];

    function randomWeatherType() {
      const r = Math.random();
      if (r < 0.5) return "Rain";
      if (r < 0.7) return "Thunderstorm";
      if (r < 0.85) return "Fog";
      if (r < 0.95) return "Wind";
      return "Ice";
    }

    const WeatherEngine = {
      generateCells() {
        radarCells = [];
        if (!weatherEnabled) return;

        const latSpan = 0.18;
        const lngSpan = 0.18;
        const latStart = BASE_CENTER[0] - latSpan / 2;
        const lngStart = BASE_CENTER[1] - lngSpan / 2;

        for (let r = 0; r < RADAR_GRID_ROWS; r++) {
          for (let c = 0; c < RADAR_GRID_COLS; c++) {
            const lat = latStart + (r + 0.5) * (latSpan / RADAR_GRID_ROWS);
            const lng = lngStart + (c + 0.5) * (lngSpan / RADAR_GRID_COLS);
            const type = randomWeatherType();
            const intensity = Math.random();

            radarCells.push({
              center: [lat, lng],
              intensity,
              type,
              dx: (Math.random() - 0.5) * 0.002,
              dy: (Math.random() - 0.5) * 0.002
            });
          }
        }
      },

      updateCells() {
        if (!weatherEnabled) return;
        radarCells.forEach((cell) => {
          cell.center[0] += cell.dy;
          cell.center[1] += cell.dx;
          cell.intensity += (Math.random() - 0.5) * 0.05;
          cell.intensity = Math.max(0, Math.min(cell.intensity, 1));
        });
      },

      colorForCell(cell) {
        const i = cell.intensity;
        switch (cell.type) {
          case "Rain":
            return { fill: `rgba(56,189,248,${0.2 + 0.4 * i})`, border: "rgba(56,189,248,0.7)", opacity: 0.3 + 0.4 * i };
          case "Thunderstorm":
            return { fill: `rgba(59,130,246,${0.3 + 0.5 * i})`, border: "rgba(59,130,246,0.9)", opacity: 0.4 + 0.4 * i };
          case "Fog":
            return { fill: `rgba(148,163,184,${0.2 + 0.4 * i})`, border: "rgba(148,163,184,0.7)", opacity: 0.3 + 0.4 * i };
          case "Ice":
            return { fill: `rgba(96,165,250,${0.3 + 0.5 * i})`, border: "rgba(96,165,250,0.9)", opacity: 0.4 + 0.4 * i };
          case "Wind":
            return { fill: `rgba(34,197,94,${0.2 + 0.4 * i})`, border: "rgba(34,197,94,0.8)", opacity: 0.3 + 0.4 * i };
          default:
            return { fill: "rgba(56,189,248,0.3)", border: "rgba(56,189,248,0.8)", opacity: 0.4 };
        }
      },

      infoForCell(cell) {
        const i = cell.intensity;
        if (cell.type === "Rain") {
          return {
            label: "Rain Cell",
            intensityLabel: i < 0.4 ? "Light" : i < 0.7 ? "Moderate" : "Heavy",
            visibility: i < 0.4 ? "1.5–2.0 mi" : i < 0.7 ? "0.8–1.2 mi" : "0.4–0.8 mi",
            speedImpact: i < 0.4 ? "-10–15%" : i < 0.7 ? "-15–25%" : "-25–35%",
            incidentRisk: i < 0.4 ? "+15%" : i < 0.7 ? "+30%" : "+45%"
          };
        }
        if (cell.type === "Thunderstorm") {
          return {
            label: "Thunderstorm Cell",
            intensityLabel: i < 0.5 ? "Strong" : "Severe",
            visibility: "0.3–0.8 mi",
            speedImpact: "-25–40%",
            incidentRisk: "+40–60%"
          };
        }
        if (cell.type === "Fog") {
          return {
            label: "Fog Bank",
            intensityLabel: i < 0.5 ? "Patchy" : "Dense",
            visibility: i < 0.5 ? "0.5–1.0 mi" : "0.1–0.4 mi",
            speedImpact: "-15–30%",
            incidentRisk: "+25–45%"
          };
        }
        if (cell.type === "Ice") {
          return {
            label: "Icy Conditions",
            intensityLabel: i < 0.5 ? "Spotty" : "Widespread",
            visibility: "Normal",
            speedImpact: "-30–60%",
            incidentRisk: "+60–80%"
          };
        }
        if (cell.type === "Wind") {
          return {
            label: "High Wind Zone",
            intensityLabel: i < 0.5 ? "Gusty" : "Strong",
            visibility: "Normal",
            speedImpact: "-10–20%",
            incidentRisk: "+15–30%"
          };
        }
        return {
          label: "Weather Cell",
          intensityLabel: "Unknown",
          visibility: "N/A",
          speedImpact: "N/A",
          incidentRisk: "N/A"
        };
      },

      render() {
        weatherLayerGroup.clearLayers();
        if (!weatherEnabled) return;

        radarCells.forEach((cell) => {
          const sizeMeters = 1200;
          const color = this.colorForCell(cell);
          const info = this.infoForCell(cell);

          const rect = L.circle(cell.center, {
            radius: sizeMeters,
            color: color.border,
            weight: 0,
            fillColor: color.fill,
            fillOpacity: color.opacity
          });

          rect.bindPopup(
            `<div style="font-size:12px;">
              <div style="font-weight:600;margin-bottom:4px;">${info.label}</div>
              <div><strong>Type:</strong> ${cell.type}</div>
              <div><strong>Intensity:</strong> ${info.intensityLabel}</div>
              <div><strong>Visibility:</strong> ${info.visibility}</div>
              <div><strong>Speed Impact:</strong> ${info.speedImpact}</div>
              <div><strong>Incident Risk:</strong> ${info.incidentRisk}</div>
            </div>`
          );

          weatherLayerGroup.addLayer(rect);
        });
      },

      // Weather factor for a corridor: sample nearest radar cells
      corridorWeatherFactor(corridorName) {
        const corridor = corridors.find((c) => c.name === corridorName);
        if (!corridor || !weatherEnabled || radarCells.length === 0) return 1;

        const samples = corridor.baseGeometry || [];
        if (!samples.length) return 1;

        let factor = 1;
        samples.forEach((pt) => {
          radarCells.forEach((cell) => {
            const distKm = haversineDistance(pt, cell.center) / 1000;
            if (distKm < 5) {
              const i = cell.intensity;
              let local = 1;
              if (cell.type === "Rain") local = 1 - 0.15 * i;
              else if (cell.type === "Thunderstorm") local = 1 - 0.3 * i;
              else if (cell.type === "Fog") local = 1 - 0.2 * i;
              else if (cell.type === "Ice") local = 1 - 0.4 * i;
              else if (cell.type === "Wind") local = 1 - 0.1 * i;
              factor = Math.min(factor, local);
            }
          });
        });
        return Math.max(0.4, factor);
      },

      // Weather modifiers for incident type weights
      typeWeightModifiers() {
        const mods = {};
        ALERT_TYPES.forEach((t) => (mods[t] = 1));
        if (!weatherEnabled || radarCells.length === 0) return mods;

        let rain = 0, storm = 0, fog = 0, ice = 0, wind = 0;
        radarCells.forEach((cell) => {
          if (cell.intensity < 0.3) return;
          if (cell.type === "Rain") rain += cell.intensity;
          if (cell.type === "Thunderstorm") storm += cell.intensity;
          if (cell.type === "Fog") fog += cell.intensity;
          if (cell.type === "Ice") ice += cell.intensity;
          if (cell.type === "Wind") wind += cell.intensity;
        });

        const scale = (x) => Math.min(2, 1 + x / 20);

        const rainF = scale(rain);
        const stormF = scale(storm);
        const fogF = scale(fog);
        const iceF = scale(ice);
        const windF = scale(wind);

        const crashBoost = Math.max(rainF, stormF, fogF, iceF);
        const badRoadBoost = Math.max(rainF, iceF);
        const debrisBoost = Math.max(stormF, windF);
        const enforcementDrop = 1 / Math.max(1, stormF + iceF);

        mods["Crash"] *= crashBoost;
        mods["Severe Crash"] *= crashBoost * 1.1;
        mods["Pile-up"] *= crashBoost * 1.1;
        mods["Bad Road Condition"] *= badRoadBoost * 1.2;
        mods["Debris"] *= debrisBoost * 1.2;
        mods["Closure"] *= badRoadBoost * 1.1;
        mods["Construction / Utility"] *= badRoadBoost;
        mods["Speed Trap"] *= enforcementDrop;
        mods["Traffic Stop"] *= enforcementDrop;
        mods["Weather Alert"] *= Math.max(rainF, stormF, fogF, iceF, windF);

        return mods;
      }
    };

    /************************************************************
     * TRAFFIC ENGINE
     ************************************************************/
    function computeSpeedGreenshields(freeFlow, density, jamDensity = 180) {
      const v = freeFlow * (1 - density / jamDensity);
      return Math.max(5, Math.min(freeFlow, v));
    }

    const TrafficEngine = {
      initState() {
        corridorState = {};
        corridors.forEach((c) => {
          if (!c.baseDemand) c.baseDemand = 1500;
          if (!c.risk) c.risk = 1.0;
          if (!c.demandProfile || c.demandProfile.length !== 24) {
            c.demandProfile = new Array(24).fill(0.5);
          }
          corridorState[c.name] = {
            history: [],
            lastValue: {
              timestamp: Date.now(),
              avgSpeed: c.freeFlowSpeed,
              congestion: 0,
              weatherFactor: 1,
              incidentFactor: 1
            }
          };
        });
      },

      simulateCorridor(corridor, weatherFactor, incidentFactor) {
        const hour = new Date().getHours();
        const demandMultiplier = corridor.demandProfile[hour] || 0.5;
        const demand = corridor.baseDemand * demandMultiplier * corridor.risk;
        const lanes = 2;
        const capacityPerLane = corridor.freeFlowSpeed * 30;
        const baseCapacity = capacityPerLane * lanes;
        const effectiveCapacity = baseCapacity * weatherFactor * incidentFactor;
        const utilization = Math.min(demand / Math.max(effectiveCapacity, 1), 1.5);
        const density = Math.min(utilization, 1) * 180;
        const rawSpeed = computeSpeedGreenshields(corridor.freeFlowSpeed, density);
        return {
          speed: rawSpeed,
          congestion: 1 - rawSpeed / corridor.freeFlowSpeed
        };
      },

      updateAll() {
        corridors.forEach((c) => {
          const state = corridorState[c.name];
          const wFactor = WeatherEngine.corridorWeatherFactor(c.name);
          const incidentFactor = this.computeIncidentFactorForCorridor(c.name);
          const sim = this.simulateCorridor(c, wFactor, incidentFactor);
          const alpha = 0.3;
          const smoothedSpeed =
            alpha * sim.speed + (1 - alpha) * state.lastValue.avgSpeed;
          const entry = {
            timestamp: Date.now(),
            avgSpeed: smoothedSpeed,
            congestion: 1 - smoothedSpeed / c.freeFlowSpeed,
            weatherFactor: wFactor,
            incidentFactor
          };
          state.lastValue = entry;
          state.history.push(entry);
          if (state.history.length > MAX_HISTORY_POINTS) state.history.shift();
        });
      },

      computeIncidentFactorForCorridor(corridorName) {
        const relevant = alerts.filter(
          (a) => a.corridorName === corridorName && !a.cleared
        );
        if (relevant.length === 0) return 1;
        let worst = 1;
        relevant.forEach((a) => {
          let sevWeight = 0.1;
          if (a.severity === "med") sevWeight = 0.2;
          else if (a.severity === "high") sevWeight = 0.35;
          else if (a.severity === "critical") sevWeight = 0.6;
          const factor = 1 - sevWeight;
          worst = Math.min(worst, factor);
        });
        return worst;
      }
    };

    /************************************************************
     * INCIDENT ENGINE
     ************************************************************/
    function severityFromType(type) {
      switch (type) {
        case "Severe Crash":
        case "Pile-up":
        case "Closure":
          return "critical";
        case "Crash":
        case "Fire / EMS":
        case "Blocked Lane":
          return "high";
        case "Construction / Utility":
        case "Bad Road Condition":
        case "Weather Alert":
          return "med";
        default:
          return "low";
      }
    }

    function pickPOIForAlert(corridor) {
      const pts = corridor.points;
      if (!pts || pts.length === 0) return null;
      const total = pts.reduce((s, p) => s + (p.weight || 1), 0);
      let r = Math.random() * total;
      for (const p of pts) {
        const w = p.weight || 1;
        if (r < w) return p;
        r -= w;
      }
      return pts[0];
    }

    function timeOfDayModifiers() {
      const hour = new Date().getHours();
      const mods = {};
      ALERT_TYPES.forEach((t) => (mods[t] = 1));

      if (hour >= 7 && hour <= 9) {
        mods["Crash"] *= 1.2;
        mods["Stopped Vehicle"] *= 1.2;
        mods["Vehicle on Shoulder"] *= 1.1;
      }

      if (hour >= 16 && hour <= 18) {
        mods["Crash"] *= 1.2;
        mods["Severe Crash"] *= 1.3;
        mods["Fire / EMS"] *= 1.2;
        mods["Blocked Lane"] *= 1.2;
      }

      if (hour >= 22 || hour <= 3) {
        mods["Police"] *= 1.3;
        mods["Speed Trap"] *= 1.3;
        mods["Traffic Stop"] *= 1.2;
        mods["Construction / Utility"] *= 0.7;
      }

      return mods;
    }

    function buildTypeWeightsForPOI(corridor, poi) {
      const weights = {};
      const todMods = timeOfDayModifiers();
      const weatherMods = WeatherEngine.typeWeightModifiers();
      const profile = corridor.incidentProfile || {
        crashRate: 1,
        enforcementRate: 1,
        constructionRate: 1,
        debrisRate: 1
      };
      const poiMods = (poi && poi.poiModifiers) || {
        crash: 1,
        enforcement: 1,
        construction: 1,
        debris: 1
      };

      ALERT_TYPES.forEach((type) => {
        let base = BASE_TYPE_WEIGHTS[type] || 1;

        let corridorFactor = 1;
        if (["Crash", "Severe Crash", "Pile-up"].includes(type)) {
          corridorFactor *= profile.crashRate || 1;
        }
        if (["Police", "Speed Trap", "Traffic Stop"].includes(type)) {
          corridorFactor *= profile.enforcementRate || 1;
        }
        if (["Construction / Utility", "Closure", "Bad Road Condition", "Weather Alert"].includes(type)) {
          corridorFactor *= profile.constructionRate || 1;
        }
        if (["Debris", "Pothole"].includes(type)) {
          corridorFactor *= profile.debrisRate || 1;
        }

        let poiFactor = 1;
        if (["Crash", "Severe Crash", "Pile-up"].includes(type)) {
          poiFactor *= poiMods.crash || 1;
        }
        if (["Police", "Speed Trap", "Traffic Stop"].includes(type)) {
          poiFactor *= poiMods.enforcement || 1;
        }
        if (["Construction / Utility", "Closure", "Bad Road Condition", "Weather Alert"].includes(type)) {
          poiFactor *= poiMods.construction || 1;
        }
        if (["Debris", "Pothole"].includes(type)) {
          poiFactor *= poiMods.debris || 1;
        }

        const todFactor = todMods[type] || 1;
        const weatherFactor = weatherMods[type] || 1;

        weights[type] = base * corridorFactor * poiFactor * todFactor * weatherFactor;
      });

      return weights;
    }

    function pickAlertTypeForPOI(corridor, poi) {
      const weights = buildTypeWeightsForPOI(corridor, poi);
      let total = 0;
      ALERT_TYPES.forEach((t) => {
        total += Math.max(weights[t], 0);
      });
      if (total <= 0) return ALERT_TYPES[0];
      let r = Math.random() * total;
      for (const t of ALERT_TYPES) {
        const w = Math.max(weights[t], 0);
        if (r < w) return t;
        r -= w;
      }
      return ALERT_TYPES[0];
    }

    const IncidentEngine = {
      generateNewIncidents() {
        const newAlerts = [];
        const now = new Date();
        const hour = now.getHours();

        corridors.forEach((c) => {
          const state = corridorState[c.name];
          const last = state.lastValue;
          const congestion = last.congestion || 0;
          const weatherFactor = last.weatherFactor || 1;

          const baseRate = 0.0004 * (c.risk || 1);
          const weatherBoost = 1 + (1 - weatherFactor) * 2;
          const congestionBoost = 1 + congestion * 3;
          const timeBoost =
            (hour >= 7 && hour <= 9) || (hour >= 16 && hour <= 18) ? 1.7 : 1.0;

          const probability =
            baseRate * weatherBoost * congestionBoost * timeBoost * SIM_TICK_SECONDS;

          if (Math.random() < probability) {
            const poi = pickPOIForAlert(c);
            if (!poi) return;

            const type = pickAlertTypeForPOI(c, poi);
            const severity = severityFromType(type);
            const departments = ALERT_DEPARTMENTS[type] || ["Traffic"];
            const confidence = 0.6 + Math.random() * 0.4;

            const durationMin = (() => {
              switch (severity) {
                case "critical": return 60 + Math.floor(Math.random() * 90);
                case "high": return 30 + Math.floor(Math.random() * 60);
                case "med": return 20 + Math.floor(Math.random() * 40);
                default: return 10 + Math.floor(Math.random() * 20);
              }
            })();

            const impactText = (() => {
              const cn = c.name;
              if (type === "Weather Alert") {
                return `Weather-related hazard reported along ${cn}; expect degraded conditions and possible delays.`;
              }
              if (severity === "critical") return `Multiple lanes blocked on ${cn}; expect long delays and rerouting.`;
              if (severity === "high") return `Significant slowdown on ${cn}; traffic moving well below posted speed.`;
              if (severity === "med") return `Moderate congestion on ${cn}; allow extra travel time.`;
              return `Minor impact reported on ${cn}; conditions mostly passable.`;
            })();

            const causeText = (() => {
              switch (type) {
                case "Severe Crash":
                case "Pile-up":
                  return "Multi-vehicle collision with major lane blockage.";
                case "Crash":
                  return "Two-vehicle crash affecting travel lanes.";
                case "Closure":
                  return "Full closure due to incident or construction.";
                case "Construction / Utility":
                  return "Planned work zone with lane shifts and reduced speeds.";
                case "Debris":
                  return "Debris reported in travel lane; crews en route.";
                case "Pothole":
                  return "Large pothole reported; patching scheduled.";
                case "Blocked Lane":
                  return "Lane blocked by incident or stalled vehicle.";
                case "Stopped Vehicle":
                case "Vehicle on Shoulder":
                  return "Disabled vehicle on shoulder or lane edge.";
                case "Fire / EMS":
                  return "Active fire/EMS response with apparatus on scene.";
                case "Bad Road Condition":
                  return "Surface conditions degraded due to weather or wear.";
                case "Speed Trap":
                  return "Targeted speed enforcement in progress.";
                case "Traffic Stop":
                  return "Traffic stop on shoulder; minor visual slowdown.";
                case "Police":
                  return "Police activity in corridor; expect intermittent slowdowns.";
                case "Weather Alert":
                  return "Weather radar indicates hazardous conditions impacting this corridor.";
                default:
                  return "Traffic disruption reported.";
              }
            })();

            newAlerts.push({
              id: Date.now() + Math.random(),
              type,
              color: ALERT_COLORS[type] || "#f97316",
              severity,
              confidence,
              durationMin,
              remainingSec: durationMin * 60,
              departments,
              corridorName: c.name,
              coord: poi.coord,
              locationName: poi.name,
              impactText,
              causeText,
              timestamp: now,
              cleared: false
            });
          }
        });

        alerts = alerts.concat(newAlerts);
      },

      updateLifecycles() {
        alerts.forEach((a) => {
          if (a.cleared) return;
          a.remainingSec -= SIM_TICK_SECONDS;

          if (!a.escalated && Math.random() < 0.05 && a.severity !== "critical") {
            if (a.severity === "low") a.severity = "med";
            else if (a.severity === "med") a.severity = "high";
            else if (a.severity === "high") a.severity = "critical";
            a.escalated = true;
          }

          if (Math.random() < 0.03 && a.remainingSec > 60) {
            a.remainingSec = 0;
          }

          if (a.remainingSec <= 0) {
            a.cleared = true;
          }
        });

        alerts = alerts.filter((a) => !a.cleared || Math.random() > 0.1);
      }
    };

    /************************************************************
     * MAP ENGINE (NO CORRIDOR LINES, ONLY RADAR + ALERT PINS)
     ************************************************************/
    const MapEngine = {
      init() {
        map = L.map("map", {
          center: BASE_CENTER,
          zoom: 12,
          zoomControl: true,
          attributionControl: false
        });

        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
          maxZoom: 19
        }).addTo(map);

        weatherLayerGroup = L.layerGroup().addTo(map);
        alertLayerGroup = L.layerGroup().addTo(map);
      },

      renderAlerts() {
        alertLayerGroup.clearLayers();
        alertMarkers = [];

        alerts.forEach((a) => {
          if (a.cleared) return;
          if (!a.coord) return;

          const hasActiveDept = a.departments.some((d) => ACTIVE_DEPARTMENTS.has(d));
          if (!hasActiveDept) return;

          const marker = L.circleMarker(a.coord, {
            radius: 7,
            color: a.color,
            weight: 2,
            fillColor: a.color,
            fillOpacity: 0.85
          });

          marker.bindPopup(
            `<div style="font-size:12px;">
              <div style="font-weight:600;margin-bottom:4px;">${a.type}</div>
              <div><strong>Location:</strong> ${a.locationName || "Corridor"}</div>
              <div><strong>Corridor:</strong> ${a.corridorName}</div>
              <div><strong>Severity:</strong> ${severityLabel(a.severity)}</div>
              <div><strong>Confidence:</strong> ${confidenceLabel(a.confidence)} (${(a.confidence * 100).toFixed(0)}%)</div>
              <div><strong>Remaining:</strong> ${Math.max(0, Math.round(a.remainingSec / 60))} min</div>
              <div style="margin-top:4px;">${a.impactText}</div>
            </div>`
          );

          marker.addTo(alertLayerGroup);
          alertMarkers.push(marker);
        });
      }
    };

    /************************************************************
     * UI ENGINE
     ************************************************************/
    function renderReportsList() {
      const container = document.getElementById("reports-list");
      container.innerHTML = "";

      const sorted = [...alerts].sort((a, b) => b.timestamp - a.timestamp);
      sorted.forEach((a) => {
        if (a.cleared) return;

        const item = document.createElement("div");
        item.className = "report-item";

        const header = document.createElement("div");
        header.className = "report-header";

        const typeEl = document.createElement("div");
        typeEl.className = "report-type";
        typeEl.innerHTML = `<span style="color:${a.color};">●</span> ${a.type}`;

        const corridorEl = document.createElement("div");
        corridorEl.className = "report-corridor";
        corridorEl.textContent = a.locationName
          ? `${a.corridorName} · ${a.locationName}`
          : a.corridorName;

        header.appendChild(typeEl);
        header.appendChild(corridorEl);

        const meta = document.createElement("div");
        meta.className = "report-meta";

        const sevSpan = document.createElement("span");
        const sevPill = document.createElement("span");
        sevPill.className = `severity-pill ${severityClass(a.severity)}`;
        sevPill.textContent = severityLabel(a.severity);
        sevSpan.appendChild(sevPill);

        const confSpan = document.createElement("span");
        confSpan.innerHTML = `<strong>Conf:</strong> ${confidenceLabel(a.confidence)} (${(a.confidence * 100).toFixed(0)}%)`;

        const timeSpan = document.createElement("span");
        timeSpan.innerHTML = `<strong>Reported:</strong> ${formatTime(a.timestamp)}`;

        const remainSpan = document.createElement("span");
        remainSpan.innerHTML = `<strong>Remaining:</strong> ${Math.max(0, Math.round(a.remainingSec / 60))} min`;

        meta.appendChild(sevSpan);
        meta.appendChild(confSpan);
        meta.appendChild(timeSpan);
        meta.appendChild(remainSpan);

        const body = document.createElement("div");
        body.className = "report-body";
        body.textContent = a.impactText;

        const footer = document.createElement("div");
        footer.className = "report-footer";

        const depts = document.createElement("div");
        depts.className = "report-depts";
        a.departments.forEach((d) => {
          const pill = document.createElement("div");
          pill.className = "report-dept-pill";
          pill.textContent = d;
          depts.appendChild(pill);
        });

        const cause = document.createElement("div");
        cause.textContent = a.causeText;

        footer.appendChild(depts);
        footer.appendChild(cause);

        item.appendChild(header);
        item.appendChild(meta);
        item.appendChild(body);
        item.appendChild(footer);

        container.appendChild(item);
      });
    }

    function initTabs() {
      const buttons = document.querySelectorAll(".tab-button");
      const contents = document.querySelectorAll(".tab-content");

      buttons.forEach((btn) => {
        btn.addEventListener("click", () => {
          const tabId = btn.getAttribute("data-tab");
          buttons.forEach((b) => b.classList.remove("active"));
          contents.forEach((c) => c.classList.remove("active"));
          btn.classList.add("active");
          document.getElementById(tabId).classList.add("active");
        });
      });
    }

    function initDeptFilters() {
      const chips = document.querySelectorAll(".dept-chip");
      chips.forEach((chip) => {
        chip.addEventListener("click", () => {
          const dept = chip.getAttribute("data-dept");
          if (chip.classList.contains("active")) {
            chip.classList.remove("active");
            ACTIVE_DEPARTMENTS.delete(dept);
          } else {
            chip.classList.add("active");
            ACTIVE_DEPARTMENTS.add(dept);
          }
          MapEngine.renderAlerts();
          renderReportsList();
        });
      });
    }

    function initWeatherToggle() {
      const btn = document.getElementById("weather-toggle");
      btn.addEventListener("click", () => {
        weatherEnabled = !weatherEnabled;
        if (weatherEnabled) {
          btn.classList.add("active");
          btn.innerHTML = `<span class="dot"></span> Radar On`;
          WeatherEngine.generateCells();
        } else {
          btn.classList.remove("active");
          btn.innerHTML = `<span class="dot"></span> Radar Off`;
          radarCells = [];
        }
        WeatherEngine.render();
      });
    }

    function initCorridorSelectAndChart() {
      const select = document.getElementById("corridor-select");
      select.innerHTML = "";
      corridors.forEach((c) => {
        const opt = document.createElement("option");
        opt.value = c.name;
        opt.textContent = c.name;
        select.appendChild(opt);
      });
      selectedCorridorName = corridors[0]?.name || null;

      select.addEventListener("change", () => {
        selectedCorridorName = select.value;
        updateCorridorChart();
      });

      const ctx = document.getElementById("corridor-chart").getContext("2d");
      corridorChart = new Chart(ctx, {
        type: "line",
        data: {
          labels: [],
          datasets: [
            {
              label: "Avg Speed (mph)",
              data: [],
              borderColor: "#38bdf8",
              backgroundColor: "rgba(56,189,248,0.15)",
              tension: 0.25,
              fill: true,
              pointRadius: 0
            },
            {
              label: "Congestion (0-1)",
              data: [],
              borderColor: "#f97316",
              backgroundColor: "rgba(249,115,22,0.15)",
              tension: 0.25,
              fill: true,
              pointRadius: 0,
              yAxisID: "y1"
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              type: "linear",
              position: "left",
              ticks: { color: "#9ca3af" },
              grid: { color: "rgba(55,65,81,0.4)" }
            },
            y1: {
              type: "linear",
              position: "right",
              min: 0,
              max: 1,
              ticks: { color: "#9ca3af" },
              grid: { drawOnChartArea: false }
            },
            x: {
              ticks: { color: "#9ca3af" },
              grid: { color: "rgba(55,65,81,0.4)" }
            }
          },
          plugins: {
            legend: {
              labels: { color: "#e5e7eb" }
            }
          }
        }
      });
    }

    function updateCorridorChart() {
      if (!corridorChart || !selectedCorridorName) return;
      const state = corridorState[selectedCorridorName];
      if (!state) return;
      const history = state.history;
      const labels = history.map((h) => formatTime(new Date(h.timestamp)));
      const speeds = history.map((h) => h.avgSpeed.toFixed(1));
      const congestion = history.map((h) => h.congestion.toFixed(2));

      corridorChart.data.labels = labels;
      corridorChart.data.datasets[0].data = speeds;
      corridorChart.data.datasets[1].data = congestion;
      corridorChart.update();
    }

    /************************************************************
     * SIMULATION LOOP
     ************************************************************/
    function tickSimulation() {
      WeatherEngine.updateCells();
      TrafficEngine.updateAll();
      IncidentEngine.generateNewIncidents();
      IncidentEngine.updateLifecycles();

      WeatherEngine.render();
      MapEngine.renderAlerts();
      renderReportsList();
      updateCorridorChart();

      simCountdown = SIM_TICK_SECONDS;
    }

    function startSimulation() {
      WeatherEngine.generateCells();
      WeatherEngine.render();
      TrafficEngine.initState();
      TrafficEngine.updateAll();

      MapEngine.renderAlerts();
      renderReportsList();
      updateCorridorChart();

      simInterval = setInterval(tickSimulation, SIM_TICK_SECONDS * 1000);

      const countdownEl = document.getElementById("sim-countdown");
      countdownInterval = setInterval(() => {
        simCountdown -= 1;
        if (simCountdown < 0) simCountdown = 0;
        countdownEl.textContent = `Next tick in ${simCountdown}s`;
      }, 1000);
    }

    /************************************************************
     * INIT
     ************************************************************/
    window.addEventListener("load", () => {
      MapEngine.init();
      initTabs();
      initDeptFilters();
      initWeatherToggle();
      initCorridorSelectAndChart();
      startSimulation();
    });
  </script>
</body>
</html>
