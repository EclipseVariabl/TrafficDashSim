<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tyler, TX Traffic & Operations Simulation - v2</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    
    <style>
        :root {
            --bg-dark: #1a1a1d;
            --panel-bg: #252529;
            --text-main: #e0e0e0;
            --accent: #4a90e2;
            --danger: #e74c3c;
            --warning: #f1c40f;
            --success: #2ecc71;
            --header-height: 60px;
        }

        body, html { margin: 0; padding: 0; height: 100%; font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background-color: var(--bg-dark); color: var(--text-main); overflow: hidden; }

        /* Layout */
        #app-container { display: flex; height: 100vh; flex-direction: column; }
        
        /* Header */
        header {
            height: var(--header-height);
            background-color: var(--panel-bg);
            border-bottom: 1px solid #333;
            display: flex;
            align-items: center;
            padding: 0 20px;
            justify-content: space-between;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            z-index: 1000;
        }

        .brand { font-size: 1.2rem; font-weight: 700; color: var(--accent); letter-spacing: 1px; }
        .brand span { color: #fff; }
        
        /* Filters */
        .controls { display: flex; gap: 10px; }
        .filter-btn {
            background: #333; border: 1px solid #444; color: #aaa;
            padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.85rem;
            transition: all 0.2s;
        }
        .filter-btn:hover { background: #444; }
        .filter-btn.active { background: var(--accent); color: white; border-color: var(--accent); }

        /* Main Content */
        #main-view { display: flex; flex: 1; position: relative; }

        /* Map */
        #map { flex: 1; background: #111; z-index: 1; }

        /* Side Panel (Reports) */
        #side-panel {
            width: 350px;
            background: var(--panel-bg);
            border-left: 1px solid #333;
            display: flex;
            flex-direction: column;
            box-shadow: -2px 0 10px rgba(0,0,0,0.5);
            z-index: 2;
        }

        .panel-header { padding: 15px; background: #2c2c30; border-bottom: 1px solid #333; font-weight: 600; display: flex; justify-content: space-between; }
        .live-indicator { color: var(--danger); font-size: 0.8rem; animation: pulse 1.5s infinite; }

        #feed-container { flex: 1; overflow-y: auto; padding: 10px; }
        
        /* Feed Items */
        .feed-item {
            background: #2e2e33; border-left: 4px solid #555;
            padding: 12px; margin-bottom: 10px; border-radius: 0 4px 4px 0;
            font-size: 0.9rem; transition: transform 0.2s;
        }
        .feed-item:hover { background: #35353a; transform: translateX(2px); }
        .feed-header { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 0.8rem; color: #888; }
        .feed-street { font-weight: bold; color: #fff; margin-bottom: 4px; }
        .feed-detail { font-size: 0.85rem; color: #ccc; }
        .feed-tags { margin-top: 8px; display: flex; gap: 5px; flex-wrap: wrap; }
        .tag { font-size: 0.7rem; padding: 2px 6px; border-radius: 3px; background: #444; color: #ccc; }
        
        /* Severity Colors */
        .sev-low { border-left-color: var(--success); }
        .sev-med { border-left-color: var(--warning); }
        .sev-high { border-left-color: var(--danger); }
        .sev-crit { border-left-color: #8e44ad; }

        /* Map Legend Overlay */
        .map-overlay {
            position: absolute; bottom: 20px; left: 20px;
            background: rgba(0,0,0,0.8); padding: 10px; border-radius: 5px;
            z-index: 1000; font-size: 0.8rem; pointer-events: none;
        }
        .legend-item { display: flex; align-items: center; margin-bottom: 4px; }
        .color-box { width: 12px; height: 12px; margin-right: 8px; border-radius: 2px; }

        /* Map Alert Icon Styles */
        .alert-marker-icon {
            background: var(--danger);
            border: 2px solid white;
            border-radius: 50%;
            box-shadow: 0 0 10px var(--danger);
            animation: pulse-marker 2s infinite;
        }

        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        @keyframes pulse-marker { 
            0% { box-shadow: 0 0 0 0px rgba(231, 76, 60, 0.7); transform: scale(1); }
            70% { box-shadow: 0 0 0 15px rgba(231, 76, 60, 0); transform: scale(1.1); }
            100% { box-shadow: 0 0 0 0px rgba(231, 76, 60, 0); transform: scale(1); }
        }
        
        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #222; }
        ::-webkit-scrollbar-thumb { background: #444; border-radius: 3px; }
    </style>
</head>
<body>

<div id="app-container">
    <header>
        <div class="brand">TYLER<span>SIM</span> <small style="font-size:0.7em; opacity:0.6; font-weight:normal;">/ TRAFFIC OPS</small></div>
        <div class="controls">
            <button class="filter-btn active" onclick="toggleLayer('all')">All</button>
            <button class="filter-btn" onclick="toggleLayer('PD')">Police</button>
            <button class="filter-btn" onclick="toggleLayer('FIRE')">Fire</button>
            <button class="filter-btn" onclick="toggleLayer('ENG')">Engineering</button>
        </div>
    </header>

    <div id="main-view">
        <div id="map"></div>
        
        <div class="map-overlay">
            <div class="legend-item"><div class="color-box" style="background:#2ecc71"></div> Free Flow</div>
            <div class="legend-item"><div class="color-box" style="background:#f1c40f"></div> Moderate</div>
            <div class="legend-item"><div class="color-box" style="background:#e74c3c"></div> Heavy</div>
            <div class="legend-item"><div class="color-box" style="background:#8e44ad"></div> Gridlock</div>
            <div class="legend-item"><div class="color-box" style="background:rgba(52, 152, 219, 0.4); border:1px solid cyan"></div> NWS Weather</div>
        </div>

        <div id="side-panel">
            <div class="panel-header">
                <span>Live Intelligence</span>
                <span class="live-indicator">‚óè LIVE</span>
            </div>
            <div id="feed-container">
                </div>
        </div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

<script>
    // --- 1. CONFIGURATION & STATE ---
    const TYLER_CENTER = [32.3513, -95.3011]; // Near downtown grid
    const UPDATE_INTERVAL = 1500; // ms
    
    // State
    let map;
    let roadLayers = [];
    let activeFilter = 'all';
    let weatherSystems = [];
    let alertLayerGroup;
    let simulationTick = 0;

    // --- 2. GEOMETRY & NETWORK GENERATION ---
    
    // Define Key Anchor Points (Intersections) to ensure perfect alignment
    const ANCHORS = {
        DOWNTOWN: [32.3513, -95.3011],
        N_LOOP:   [32.4025, -95.3000], // N Broadway & Loop 323
        S_LOOP:   [32.3055, -95.3020], // S Broadway & Loop 323
        E_LOOP:   [32.3500, -95.2310], // E Loop & SH31
        W_LOOP:   [32.3520, -95.3700], // W Loop & SH31
        SE_LOOP:  [32.3160, -95.2510], // Troup Hwy & Loop
        SW_LOOP:  [32.3150, -95.3500], // Old Jax & Loop
        NE_LOOP:  [32.3850, -95.2500],
        NW_LOOP:  [32.3850, -95.3500]
    };

    // Helper to create dense points between two anchors for smooth lines
    function generateDensifiedPath(start, end, segments) {
        const path = [];
        for (let i = 0; i <= segments; i++) {
            const t = i / segments;
            const lat = start[0] + (end[0] - start[0]) * t;
            const lng = start[1] + (end[1] - start[1]) * t;
            path.push([lat, lng]);
        }
        return path;
    }

    function generateRoadNetwork() {
        // 1. Generate Loop 323 Ring (connecting the outer anchors)
        const loop anchors = [ANCHORS.N_LOOP, ANCHORS.NE_LOOP, ANCHORS.E_LOOP, ANCHORS.SE_LOOP, ANCHORS.S_LOOP, ANCHORS.SW_LOOP, ANCHORS.W_LOOP, ANCHORS.NW_LOOP, ANCHORS.N_LOOP];
        for(let i=0; i<anchors.length-1; i++) {
            // Create slightly curved segments between anchors for the loop
            const path = generateDensifiedPath(anchors[i], anchors[i+1], 8);
            createRoadEntity("Loop 323", path, 55, getLoopSector(anchors[i]));
        }

        // 2. Generate Spoke Arteries (connecting Downtown to Loop anchors)
        // Broadway Axis (N/S)
        createRoadEntity("N Broadway Ave", generateDensifiedPath(ANCHORS.DOWNTOWN, ANCHORS.N_LOOP, 12), 40);
        createRoadEntity("S Broadway Ave", generateDensifiedPath(ANCHORS.DOWNTOWN, ANCHORS.S_LOOP, 15), 45);
        
        // SH-31 Axis (E/W)
        createRoadEntity("E Front St (SH-31)", generateDensifiedPath(ANCHORS.DOWNTOWN, ANCHORS.E_LOOP, 12), 45);
        createRoadEntity("W Front St (SH-31)", generateDensifiedPath(ANCHORS.DOWNTOWN, ANCHORS.W_LOOP, 12), 50);

        // Diagonals
        createRoadEntity("Troup Hwy", generateDensifiedPath(ANCHORS.DOWNTOWN, ANCHORS.SE_LOOP, 10), 50);
        createRoadEntity("Old Jacksonville Hwy", generateDensifiedPath([32.335, -95.3011], ANCHORS.SW_LOOP, 10), 50); // Starts slightly south of downtown

        // Downtown Grid (simplified square)
        const gridBox = [[32.355, -95.305], [32.355, -95.297], [32.347, -95.297], [32.347, -95.305], [32.355, -95.305]];
        createRoadEntity("Downtown Grid", gridBox, 30);
    }

    function getLoopSector(latlng) {
        if(latlng[0] > 32.38) return "N Loop 323";
        if(latlng[0] < 32.32) return "S Loop 323";
        if(latlng[1] > -95.27) return "E Loop 323";
        return "W Loop 323";
    }

    function createRoadEntity(name, coords, baseSpeed, specificNameOverride = null) {
        const displayName = specificNameOverride || name;
        const depts = assignDepartments(displayName);

        const roadObj = {
            id: Math.random().toString(36).substr(2, 9),
            name: displayName,
            coords: coords,
            baseSpeed: baseSpeed,
            currentSpeed: baseSpeed,
            departments: depts,
            congestion: Math.random() * 0.2, // Start with slight variation
            polyline: null
        };

        // Create Leaflet Polyline
        const line = L.polyline(coords, {
            color: '#2ecc71', // Initial Green
            weight: 5,
            opacity: 0.8,
            lineCap: 'round',
            lineJoin: 'round',
            smoothFactor: 1
        }).addTo(map);

        // Popup
        line.bindPopup(() => generatePopupContent(roadObj));
        
        // Hover effects
        line.on('mouseover', function(e) { this.setStyle({ weight: 8, opacity: 1 }); });
        line.on('mouseout', function(e) { updateRoadColor(roadObj); }); // Reset to correct color/weight

        roadObj.polyline = line;
        roadLayers.push(roadObj);
    }

    function assignDepartments(name) {
        const d = ['PD']; // PD everywhere
        if (name.includes('Loop')) d.push('TRAFFIC', 'ENG');
        if (name.includes('Broadway') || name.includes('Front')) d.push('FIRE', 'TRAFFIC');
        if (name.includes('Downtown')) d.push('STREETS');
        return [...new Set(d)]; // Unique
    }

    // --- 3. INITIALIZATION ---

    function initMap() {
        map = L.map('map', {
            center: TYLER_CENTER,
            zoom: 12,
            minZoom: 11,
            zoomControl: false,
            attributionControl: false
        });
        
        // CartoDB Dark Matter tiles
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            maxZoom: 19
        }).addTo(map);

        L.control.zoom({ position: 'topright' }).addTo(map);

        alertLayerGroup = L.layerGroup().addTo(map);

        generateRoadNetwork();
        initWeather();
        
        // Start Sim loop
        updateSimulation();
        setInterval(updateSimulation, UPDATE_INTERVAL);
    }

    // --- 4. SIMULATION LOGIC ---

    function initWeather() {
        for(let i=0; i<3; i++) createWeatherSystem();
    }

    function createWeatherSystem() {
        // Start weather off-center and drift it
        const startLat = TYLER_CENTER[0] + (Math.random() > 0.5 ? 1 : -1) * (0.05 + Math.random() * 0.1);
        const startLng = TYLER_CENTER[1] + (Math.random() > 0.5 ? 1 : -1) * (0.05 + Math.random() * 0.1);
        
        const circle = L.circle([startLat, startLng], {
            color: 'cyan', fillColor: '#3498db', fillOpacity: 0.2,
            radius: 2000 + Math.random() * 3000, weight: 1, interactive: false
        }).addTo(map);

        weatherSystems.push({
            layer: circle,
            center: [startLat, startLng],
            drift: [(Math.random()-0.5)*0.0015, (Math.random()-0.5)*0.0015]
        });
    }

    function updateSimulation() {
        simulationTick++;
        updateWeather();

        // Update Road Physics
        roadLayers.forEach(road => {
            let speedFactor = 1.0;
            // Check middle of road segment for weather impact
            const midPoint = road.coords[Math.floor(road.coords.length/2)];
            if (isUnderWeather(midPoint)) speedFactor -= 0.25;

            // Dynamic congestion flux
            if (Math.random() > 0.97) road.congestion = Math.min(1, road.congestion + 0.3); // Spike
            else road.congestion = Math.max(0, road.congestion - 0.02); // Recovery

            // Calculate Speed
            const effSpeed = road.baseSpeed * speedFactor * (1 - road.congestion);
            road.currentSpeed = Math.max(5, effSpeed);
            
            updateRoadColor(road);
        });

        // Generate Incident (Waze Style)
        if (simulationTick % 6 === 0 && Math.random() > 0.3) {
            generateIncidentReport();
        }
    }

    function updateWeather() {
        weatherSystems.forEach(sys => {
            sys.center[0] += sys.drift[0];
            sys.center[1] += sys.drift[1];
            // Simple bounce bounds
            if (Math.abs(sys.center[0] - TYLER_CENTER[0]) > 0.15) sys.drift[0] *= -1;
            if (Math.abs(sys.center[1] - TYLER_CENTER[1]) > 0.15) sys.drift[1] *= -1;
            sys.layer.setLatLng(sys.center);
        });
    }

    function isUnderWeather(latlng) {
        for(let w of weatherSystems) {
             // Simple approximation for performance
            if(Math.abs(latlng[0] - w.center[0]) < 0.03 && Math.abs(latlng[1] - w.center[1]) < 0.03) return true;
        }
        return false;
    }

    function updateRoadColor(road) {
        const ratio = road.currentSpeed / road.baseSpeed;
        let color = '#2ecc71'; // Green
        let weight = 5;
        
        if (ratio < 0.35) { color = '#8e44ad'; weight = 7; } // Gridlock
        else if (ratio < 0.6) { color = '#e74c3c'; weight = 6; } // Heavy
        else if (ratio < 0.85) { color = '#f1c40f'; weight = 5; } // Moderate
        
        // Filter Visibility check
        const isVisible = activeFilter === 'all' || road.departments.includes(activeFilter);
        road.polyline.setStyle({ 
            color: color, 
            opacity: isVisible ? 0.8 : 0.1,
            weight: isVisible ? weight : 3
        });
    }

    // --- 5. UI, REPORTS & ALERTS ---

    const incidents = [
        {type: "Accident Major", icon: "üí•"}, {type: "Vehicle Stalled", icon: "üöó"},
        {type: "Road Debris", icon: "‚ö†Ô∏è"}, {type: "Traffic Signal Out", icon: "üö¶"},
        {type: "Heavy Congestion", icon: "üõë"}, {type: "Construction", icon: "üöß"}
    ];

    function generateIncidentReport() {
        // Find congested roads
        const candidates = roadLayers.filter(r => r.congestion > 0.4);
        if (candidates.length === 0) return;

        const road = candidates[Math.floor(Math.random() * candidates.length)];
        const incident data = incidents[Math.floor(Math.random() * incidents.length)];
        const confidence = Math.floor(Math.random() * 15) + 85;
        
        let severity = road.congestion > 0.7 ? 'high' : 'med';

        // 1. Add to Sidebar Feed
        const feed = document.getElementById('feed-container');
        const item = document.createElement('div');
        item.className = `feed-item sev-${severity}`;
        const time = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', second:'2-digit'});
        const tagsHtml = road.departments.map(d => `<span class="tag">${d}</span>`).join('');

        item.innerHTML = `
            <div class="feed-header"><span>${time}</span><span>${confidence}% Conf</span></div>
            <div class="feed-street">${incident.icon} ${road.name}</div>
            <div class="feed-detail">${incident.data.type} - Current Speed: ${Math.round(road.currentSpeed)} mph</div>
            <div class="feed-tags">${tagsHtml}</div>
        `;
        feed.insertBefore(item, feed.firstChild);
        if (feed.children.length > 15) feed.removeChild(feed.lastChild);

        // 2. Add Alert Marker to Map (The fix for missing alerts)
        const latlngs = road.polyline.getLatLngs();
        // Pick a random point along the road segment
        const incidentPoint = latlngs[Math.floor(Math.random() * (latlngs.length-1))];

        const alertIcon = L.divIcon({
            className: 'alert-marker-icon',
            iconSize: [24, 24],
            html: `<div style="text-align:center; line-height:24px; font-size:14px;">${incident.icon}</div>`
        });

        const marker = L.marker(incidentPoint, {icon: alertIcon})
            .bindPopup(`<b>${incident.data.type}</b><br>${road.name}<br>Confidence: ${confidence}%`)
            .addTo(alertLayerGroup);

        // Auto-remove marker after some time (simulation of incident clearing)
        setTimeout(() => { alertLayerGroup.removeLayer(marker); }, 25000);
    }

    function generatePopupContent(road) {
        return `
            <div style="font-family: sans-serif; min-width: 180px;">
                <h3 style="margin:0 0 8px 0; font-size:16px; border-bottom:2px solid ${road.polyline.options.color}">${road.name}</h3>
                <div><strong>Speed:</strong> ${Math.round(road.currentSpeed)} / ${road.baseSpeed} mph</div>
                <div><strong>Congestion:</strong> ${Math.round(road.congestion*100)}%</div>
                <div style="margin-top:8px; font-size:0.9em"><strong>TEAMS:</strong> ${road.departments.join(', ')}</div>
            </div>
        `;
    }

    window.toggleLayer = function(dept) {
        activeFilter = dept;
        document.querySelectorAll('.filter-btn').forEach(b => {
            b.classList.toggle('active', b.textContent.toUpperCase().includes(dept) || (dept==='all' && b.textContent === 'All'));
        });
        roadLayers.forEach(r => updateRoadColor(r));
    }

    initMap();

</script>
</body>
</html>
