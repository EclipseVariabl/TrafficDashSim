<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tyler, TX Traffic Dashboard</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<style>
  html, body { height: 100%; margin: 0; font-family: Arial, sans-serif; background: #ececec; }
  #topbar {
    position: fixed; top: 0; left: 0; right: 0; height: 60px;
    background: #1b2838; color: #fff; display: flex; align-items: center;
    padding: 0 12px; font-size: 15px; z-index: 1001;
  }
  #topbar .btn {
    margin-right: 12px; padding: 8px 12px; border: none;
    cursor: pointer; border-radius: 4px; font-size: 14px;
  }
  #topbar .btn.active { background: #66c0f4; color: #1b2838; }
  #weather-toggle { margin-left: 15px; }
  #sim-status { margin-left: auto; font-weight: bold; color: #9acdff; }
  #map { position: absolute; top: 60px; bottom: 0; left: 0; right: 300px; }
  #reports {
    position: fixed; top: 60px; right: 0; bottom: 0; width: 300px;
    background: #fff; border-left: 2px solid #ddd; overflow-y: auto;
    padding: 12px; font-size: 14px;
  }
  #reports h3 { margin-top: 0; font-size: 18px; border-bottom: 1px solid #ccc; padding-bottom: 6px; }
  .report-card {
    border: 1px solid #ddd; margin-bottom: 8px; border-radius: 4px;
    padding: 8px; background: #fafafa;
  }
  .report-card .severity {
    font-weight: bold;
    color: #d9534f;
  }
  .traffic-line { stroke-linecap: round; }
</style>
</head>
<body>

<div id="topbar">
  <button class="btn active dept-btn" data-dept="Police">Police</button>
  <button class="btn active dept-btn" data-dept="Fire">Fire</button>
  <button class="btn active dept-btn" data-dept="Traffic">Traffic</button>
  <button class="btn active dept-btn" data-dept="Streets">Streets</button>

  <label id="weather-toggle">
    <input type="checkbox" checked /> Weather
  </label>

  <span id="sim-status">Initializing...</span>
</div>

<div id="map"></div>

<div id="reports">
  <h3>Incident Reports</h3>
  <div id="report-list"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>

// -----------------------------
// Utility Functions
function randomBetween(min, max) { return Math.random() * (max - min) + min; }
function dist(a, b) { return Math.sqrt((a[0] - b[0])**2 + (a[1] - b[1])**2); }
function densify(points) {
  const densified = [];
  for (let i = 0; i < points.length - 1; i++) {
    const [lat1, lng1] = points[i], [lat2, lng2] = points[i+1];
    const d = dist(points[i], points[i+1]);
    const steps = Math.max(Math.ceil(d / 0.00035), 1);
    for (let s = 0; s < steps; s++) {
      const t = s / steps;
      densified.push([lat1 + (lat2 - lat1) * t, lng1 + (lng2 - lng1) * t]);
    }
  }
  densified.push(points[points.length - 1]);
  return densified;
}

// -----------------------------
// Map & Layers
const map = L.map('map').setView([32.351, -95.301], 13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

const trafficLayer = L.layerGroup().addTo(map);
const alertLayer = L.layerGroup().addTo(map);

// -----------------------------
// Road Data (Tyler‑approximate coords)
// These follow real directions/layouts: N/S, E/W grids, and Loop 323 circles around.
const roads = [
  { name:"Broadway Ave", pts:[[32.380,-95.301],[32.360,-95.301],[32.345,-95.301]], speed:40, deps:["Traffic","Streets"] },
  { name:"Loop 323 North", pts:[[32.380,-95.285],[32.370,-95.270],[32.355,-95.265]], speed:50, deps:["Traffic","Engineering"] },
  { name:"Loop 323 West", pts:[[32.355,-95.265],[32.340,-95.280],[32.330,-95.300]], speed:50, deps:["Traffic","Engineering"] },
  { name:"Loop 323 South", pts:[[32.330,-95.300],[32.335,-95.320],[32.350,-95.330]], speed:50, deps:["Traffic","Engineering"] },
  { name:"Loop 323 East", pts:[[32.350,-95.330],[32.370,-95.325],[32.380,-95.300]], speed:50, deps:["Traffic","Engineering"] },

  { name:"SH‑31 (Front St)", pts:[[32.350,-95.310],[32.355,-95.315],[32.360,-95.320]], speed:45, deps:["Traffic","Streets"] },
  { name:"University Blvd", pts:[[32.345,-95.300],[32.350,-95.290],[32.355,-95.280]], speed:40, deps:["Traffic","Police"] },
  { name:"Old Jacksonville Hwy", pts:[[32.360,-95.290],[32.365,-95.285],[32.370,-95.280]], speed:45, deps:["Traffic","Engineering"] },
  { name:"Troup Hwy", pts:[[32.370,-95.315],[32.375,-95.310],[32.380,-95.305]], speed:45, deps:["Traffic","Streets"] },

  // Downtown grid (approx aligned N/S, E/W)
  { name:"1st St E‑W", pts:[[32.350,-95.306],[32.355,-95.306],[32.360,-95.306]], speed:30, deps:["Traffic","Police"] },
  { name:"2nd St E‑W", pts:[[32.350,-95.303],[32.355,-95.303],[32.360,-95.303]], speed:30, deps:["Traffic","Police"] },
  { name:"Erwin St", pts:[[32.350,-95.300],[32.355,-95.300],[32.360,-95.300]], speed:30, deps:["Traffic","Police"] },
  { name:"Front St E‑W", pts:[[32.350,-95.297],[32.355,-95.297],[32.360,-95.297]], speed:30, deps:["Traffic","Police"] },
  { name:"5th St", pts:[[32.350,-95.309],[32.355,-95.309],[32.360,-95.309]], speed:25, deps:["Traffic","Police"] },
  { name:"6th St", pts:[[32.349,-95.309],[32.354,-95.309],[32.359,-95.309]], speed:25, deps:["Traffic","Police"] },

  // Additional connectors
  { name:"Beckham Ave", pts:[[32.355,-95.305],[32.355,-95.295]], speed:35, deps:["Traffic","Streets"] },
  { name:"Gentry Pkwy", pts:[[32.360,-95.315],[32.365,-95.315]], speed:40, deps:["Traffic","Engineering"] },
  { name:"Main St", pts:[[32.350,-95.310],[32.350,-95.290]], speed:30, deps:["Traffic","Streets"] },
  { name:"Pine St", pts:[[32.350,-95.304],[32.350,-95.294]], speed:30, deps:["Traffic","Streets"] },
  { name:"Oak St", pts:[[32.348,-95.303],[32.348,-95.293]], speed:30, deps:["Traffic","Streets"] },
  { name:"Maple Ave", pts:[[32.352,-95.300],[32.352,-95.290]], speed:30, deps:["Traffic","Police"] },
  { name:"Tyler Ave", pts:[[32.354,-95.299],[32.354,-95.289]], speed:30, deps:["Traffic","Police"] }
];

// Prepare densified geometry
roads.forEach(r => {
  r.densified = densify(r.pts);
  r.speeds = r.densified.map(()=>r.speed);
});

// Weather
let weatherEnabled = true;
const weatherZones = [
  { center:[32.355,-95.300], radius:0.006, intensity:0.5 },
  { center:[32.365,-95.310], radius:0.008, intensity:0.6 }
];

// Alerts
let activeAlerts = [];
function generateAlerts(){
  activeAlerts = [];
  roads.forEach(road => {
    if(Math.random() < .10){
      let i = Math.floor(Math.random()*road.densified.length);
      let t = Math.floor(Math.random()*alertTypes.length);
      activeAlerts.push({
        type: alertTypes[t],
        corridor: road.name,
        severity: Math.ceil(randomBetween(1,5)),
        confidence: randomBetween(0.75,0.99),
        duration: randomBetween(5,25),
        department: road.deps[Math.floor(Math.random()*road.deps.length)],
        latlng: road.densified[i]
      });
    }
  });
}

// Render Functions
function renderTraffic(){
  trafficLayer.clearLayers();
  roads.forEach(road => {
    for(let i=0; i<road.densified.length-1; i++){
      let spd = road.speeds[i];
      let r = spd / road.speed;
      let colorIdx = Math.min(Math.floor((1-r)*congestionColors.length), congestionColors.length-1);
      L.polyline([road.densified[i], road.densified[i+1]], {
        color: congestionColors[colorIdx],
        weight: 6,
        className: 'traffic-line'
      }).bindPopup(`<b>${road.name}</b><br>Speed: ${spd.toFixed(1)} mph`)
        .addTo(trafficLayer);
    }
  });
}

function renderAlerts(){
  alertLayer.clearLayers();
  const activeDepts = Array.from(document.querySelectorAll('.dept-btn.active'))
    .map(b => b.dataset.dept);
  activeAlerts.forEach(alert => {
    if(!activeDepts.includes(alert.department)) return;
    let clr = alertColors[alertTypes.indexOf(alert.type)];
    L.circleMarker(alert.latlng, {color: clr, radius: 8, fill:true, fillOpacity:1})
      .bindPopup(`<b>${alert.type}</b><br>${alert.corridor}<br>Severity: ${alert.severity}`)
      .addTo(alertLayer);
  });
}

function renderReports(){
  const container = document.getElementById('report-list');
  container.innerHTML = '';
  activeAlerts.forEach(a => {
    container.innerHTML += `<div class="report-card"><b>${a.type}</b><br>
      <span class="severity">Severity:</span> ${a.severity}<br>
      Confidence: ${a.confidence.toFixed(2)}<br>
      Dept: ${a.department}<br>
      Corridor: ${a.corridor}</div>`;
  });
}

// Simulation Step
function simulationTickFunc(){
  document.getElementById('sim-status').innerText = "Simulation Running";
  roads.forEach(road => {
    road.speeds = road.speeds.map(s => Math.max(5, Math.min(road.speed, s + randomBetween(-4,4))));
    if(weatherEnabled){
      road.densified.forEach((pt,i) => {
        weatherZones.forEach(z => {
          let d = dist(pt, z.center);
          if(d < z.radius) road.speeds[i] *= (1 - z.intensity);
        });
      });
    }
  });
  generateAlerts();
  renderTraffic();
  renderAlerts();
  renderReports();
}

// Dept filter toggle
document.querySelectorAll('.dept-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    btn.classList.toggle('active');
    renderAlerts();
  });
});

// Weather toggle
document.querySelector('#weather-toggle input').addEventListener('change', e => {
  weatherEnabled = e.target.checked;
});

// Initial run
simulationTickFunc();
setInterval(simulationTickFunc, simulationTick);

</script>
</body>
</html>
