<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Tyler, TX – Traffic Operations Simulator</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.css" rel="stylesheet"/>
<script src="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
html,body{margin:0;height:100%;font-family:Inter,system-ui;}
#app{display:flex;flex-direction:column;height:100%}
header{background:#1f2d3d;color:white;padding:10px 16px}
main{flex:1;display:flex;min-height:0}
#map{flex:2}
#side{flex:1;overflow:auto;background:#f5f7fa;padding:10px}
.card{background:white;border-radius:8px;padding:10px;margin-bottom:10px;box-shadow:0 2px 8px rgba(0,0,0,.1)}
.incident{padding:6px;border-left:6px solid;margin-bottom:6px;background:#fafafa}
.alert{font-weight:600}

.alert-marker{
  width:20px;height:20px;border-radius:50%;
  border:3px solid white;
  animation:pulse 1.4s infinite;
}
@keyframes pulse{
  0%{transform:scale(.9);opacity:.6}
  50%{transform:scale(1.3);opacity:1}
  100%{transform:scale(.9);opacity:.6}
}
</style>
</head>
<body>
<div id="app">
<header>
  <strong>Tyler, TX – Traffic / Engineering / Public Safety Simulator</strong>
  <div id="status">Initializing…</div>
</header>

<main>
  <div id="map"></div>
  <div id="side">
    <div class="card">
      <h3>Active Reports</h3>
      <div id="list"></div>
    </div>
    <div class="card">
      <h3>Average Traffic Speed (mph)</h3>
      <canvas id="chart"></canvas>
    </div>
  </div>
</main>
</div>

<script>
/* ---------------- MAP ---------------- */
const map = new maplibregl.Map({
  container:'map',
  center:[-95.3011,32.3513],
  zoom:12,
  style:{
    version:8,
    sources:{
      base:{
        type:'raster',
        tiles:[
          "https://cartodb-basemaps-a.global.ssl.fastly.net/rastertiles/voyager/{z}/{x}/{y}.png"
        ],
        tileSize:256
      }
    },
    layers:[{id:'base',type:'raster',source:'base'}]
  }
});
map.addControl(new maplibregl.NavigationControl());

/* ---------------- DATA ---------------- */
const locations=[
  ["Broadway & Bois D'Arc",-95.3011,32.3513],
  ["Loop 323 & Troup Hwy",-95.260,32.341],
  ["Old Jacksonville & Garden Valley",-95.282,32.3145],
  ["Caldwell & Front",-95.290,32.345],
  ["MLK & Gentry",-95.320,32.308],
  ["Grande & Cumberland",-95.290,32.366],
  ["Rusk & College",-95.310,32.352],
  ["E 5th & Timber",-95.270,32.364]
];

const types=[
 {t:"Accident – Major",c:"#c0392b",impact:0.8,critical:true},
 {t:"Accident – Minor",c:"#e74c3c",impact:0.5,critical:true},
 {t:"Road Closure – Emergency",c:"#8e0000",impact:0.9,critical:true},
 {t:"Road Closure – Construction",c:"#d35400",impact:0.6,critical:true},
 {t:"Hazard – Debris",c:"#16a085",impact:0.3,critical:true},
 {t:"Hazard – Fallen Tree",c:"#1abc9c",impact:0.4,critical:true},
 {t:"Police – Speed Trap",c:"#8e44ad",impact:0.2,critical:true},
 {t:"Police – Traffic Stop",c:"#9b59b6",impact:0.3,critical:true},
 {t:"Weather – Heavy Rain",c:"#3498db",impact:0.4},
 {t:"Weather – Fog",c:"#5dade2",impact:0.3},
 {t:"Disabled Vehicle",c:"#f1c40f",impact:0.3},
 {t:"Heavy Traffic",c:"#f39c12",impact:0.5}
];

let incidents=[];
let markers=[];

/* ---------------- HEATMAP ---------------- */
map.on('load',()=>{
  map.addSource('heat',{
    type:'geojson',
    data:{type:'FeatureCollection',features:[]}
  });
  map.addLayer({
    id:'heat-layer',
    type:'heatmap',
    source:'heat',
    paint:{
      'heatmap-radius':20,
      'heatmap-intensity':1,
      'heatmap-opacity':0.6
    }
  });
});

/* ---------------- SIMULATION ---------------- */
function generate(){
  const now=Date.now();
  incidents=incidents.filter(i=>now-i.time<600000);

  while(incidents.length<Math.floor(Math.random()*18)+2){
    const l=locations[Math.floor(Math.random()*locations.length)];
    const t=types[Math.floor(Math.random()*types.length)];
    incidents.push({
      id:Math.random(),
      type:t,
      name:l[0],
      coords:[l[1],l[2]],
      time:now
    });
  }
}

function draw(){
  markers.forEach(m=>m.remove());
  markers=[];

  incidents.forEach(i=>{
    const el=document.createElement('div');
    el.style.background=i.type.c;
    el.style.width=i.type.critical?'20px':'14px';
    el.style.height=i.type.critical?'20px':'14px';
    el.style.borderRadius='50%';
    el.style.border='2px solid white';
    if(i.type.critical)el.className='alert-marker';

    markers.push(
      new maplibregl.Marker(el)
        .setLngLat(i.coords)
        .setPopup(new maplibregl.Popup({offset:25})
        .setHTML(`<strong>${i.type.t}</strong><br>${i.name}`))
        .addTo(map)
    );
  });

  map.getSource('heat').setData({
    type:'FeatureCollection',
    features:incidents.map(i=>({
      type:'Feature',
      geometry:{type:'Point',coordinates:i.coords}
    }))
  });

  document.getElementById('list').innerHTML=
    incidents
      .sort((a,b)=>b.time-a.time)
      .map(i=>`<div class="incident ${i.type.critical?'alert':''}" style="border-color:${i.type.c}">
        ${i.type.t}<br><small>${i.name}</small>
      </div>`).join('');
}

/* ---------------- CHART ---------------- */
const chart=new Chart(document.getElementById('chart'),{
  type:'line',
  data:{labels:[],datasets:[{data:[],borderColor:'#3498db',fill:true}]},
  options:{plugins:{legend:{display:false}},scales:{y:{min:5,max:60}}}
});

function updateChart(){
  let speed=50;
  incidents.forEach(i=>speed-=i.type.impact*5);
  speed=Math.max(10,speed-Math.random()*4);
  chart.data.labels.push(new Date().toLocaleTimeString());
  chart.data.datasets[0].data.push(speed);
  if(chart.data.labels.length>10){
    chart.data.labels.shift();
    chart.data.datasets[0].data.shift();
  }
  chart.update();
}

/* ---------------- LOOP ---------------- */
function tick(){
  generate();
  draw();
  updateChart();
  document.getElementById('status').textContent=
    `Active reports: ${incidents.length} | Updated ${new Date().toLocaleTimeString()}`;
}

tick();
setInterval(tick,60000);
</script>
</body>
</html>
