<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tyler, TX Traffic Management System</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            color: #2c3e50;
            overflow: hidden;
        }

        #header {
            background: linear-gradient(135deg, #1e3a5f 0%, #2c5282 100%);
            padding: 12px 30px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 3px solid #3182ce;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .seal {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #3182ce 0%, #2c5282 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            font-size: 20px;
            border: 3px solid #fff;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .header-title {
            display: flex;
            flex-direction: column;
        }

        #header h1 {
            font-size: 22px;
            color: #ffffff;
            font-weight: 600;
            letter-spacing: 0.5px;
            margin: 0;
        }

        .header-subtitle {
            font-size: 12px;
            color: #cbd5e0;
            margin-top: 2px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-primary {
            background: #3182ce;
            color: #fff;
            border: 1px solid #2c5282;
        }

        .btn-primary:hover {
            background: #2c5282;
            box-shadow: 0 2px 6px rgba(49, 130, 206, 0.4);
        }

        .btn-secondary {
            background: #718096;
            color: #fff;
            border: 1px solid #4a5568;
        }

        .btn-secondary:hover {
            background: #4a5568;
        }

        #container {
            display: flex;
            height: calc(100vh - 80px);
            background: #e2e8f0;
        }

        #left-panel {
            width: 350px;
            background: #ffffff;
            border-right: 2px solid #cbd5e0;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 2px 0 8px rgba(0,0,0,0.1);
        }

        #map {
            flex: 1;
            background: #f7fafc;
            position: relative;
        }

        #right-panel {
            width: 350px;
            background: #ffffff;
            border-left: 2px solid #cbd5e0;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: -2px 0 8px rgba(0,0,0,0.1);
        }

        .panel-section {
            padding: 20px;
            border-bottom: 1px solid #e2e8f0;
        }

        .panel-section h2 {
            font-size: 14px;
            margin-bottom: 12px;
            color: #2d3748;
            display: flex;
            justify-content: space-between;
            align-items: center;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
            border-left: 4px solid #3182ce;
            padding-left: 12px;
        }

        .dept-filter {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .dept-btn {
            padding: 10px 15px;
            border: 1px solid #cbd5e0;
            background: #f7fafc;
            color: #2d3748;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
            text-align: left;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .dept-btn:before {
            content: '';
            width: 12px;
            height: 12px;
            border: 2px solid #cbd5e0;
            border-radius: 2px;
            background: white;
            transition: all 0.2s;
        }

        .dept-btn.active {
            border-color: #3182ce;
            background: #ebf8ff;
            color: #2c5282;
        }

        .dept-btn.active:before {
            background: #3182ce;
            border-color: #3182ce;
        }

        .dept-btn:hover {
            background: #edf2f7;
            border-color: #a0aec0;
        }

        #weather-info {
            background: #edf2f7;
            padding: 15px;
            border-radius: 6px;
            border: 1px solid #cbd5e0;
            font-size: 13px;
        }

        .weather-stat {
            display: flex;
            justify-content: space-between;
            margin: 8px 0;
            padding: 6px 0;
            border-bottom: 1px solid #e2e8f0;
        }

        .weather-stat:last-child {
            border-bottom: none;
        }

        .weather-stat span:first-child {
            color: #4a5568;
            font-weight: 500;
        }

        .weather-stat span:last-child {
            color: #2d3748;
            font-weight: 600;
        }

        #reports-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #f7fafc;
        }

        .report-card {
            background: #ffffff;
            border-left: 4px solid;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 4px;
            transition: all 0.2s;
            cursor: pointer;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border-right: 1px solid #e2e8f0;
            border-top: 1px solid #e2e8f0;
            border-bottom: 1px solid #e2e8f0;
        }

        .report-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transform: translateY(-2px);
        }

        .report-card.severity-critical {
            border-left-color: #e53e3e;
            background: #fff5f5;
        }

        .report-card.severity-high {
            border-left-color: #dd6b20;
            background: #fffaf0;
        }

        .report-card.severity-medium {
            border-left-color: #d69e2e;
            background: #fffff0;
        }

        .report-card.severity-low {
            border-left-color: #38a169;
            background: #f0fff4;
        }

        .report-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 10px;
        }

        .report-title {
            font-weight: 600;
            font-size: 14px;
            color: #2d3748;
        }

        .report-time {
            font-size: 11px;
            color: #718096;
            background: #edf2f7;
            padding: 3px 8px;
            border-radius: 3px;
        }

        .report-location {
            font-size: 13px;
            color: #3182ce;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .report-details {
            font-size: 13px;
            color: #4a5568;
            margin-bottom: 10px;
            line-height: 1.5;
        }

        .report-meta {
            display: flex;
            gap: 8px;
            font-size: 11px;
            color: #718096;
            flex-wrap: wrap;
        }

        .report-badge {
            background: #edf2f7;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            border: 1px solid #cbd5e0;
            color: #4a5568;
            font-weight: 500;
        }

        .legend {
            padding: 15px;
            background: #edf2f7;
            border-radius: 6px;
            font-size: 12px;
            border: 1px solid #cbd5e0;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin: 8px 0;
            color: #4a5568;
        }

        .legend-color {
            width: 40px;
            height: 5px;
            margin-right: 10px;
            border-radius: 3px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 12px;
        }

        .stat-box {
            background: linear-gradient(135deg, #3182ce 0%, #2c5282 100%);
            padding: 15px;
            border-radius: 6px;
            text-align: center;
            box-shadow: 0 2px 6px rgba(49, 130, 206, 0.3);
        }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            color: #ffffff;
        }

        .stat-label {
            font-size: 11px;
            color: #cbd5e0;
            margin-top: 5px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        ::-webkit-scrollbar {
            width: 10px;
        }

        ::-webkit-scrollbar-track {
            background: #edf2f7;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e0;
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #a0aec0;
        }

        .leaflet-popup-content-wrapper {
            background: #ffffff;
            color: #2d3748;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border: 1px solid #e2e8f0;
        }

        .leaflet-popup-content {
            margin: 15px;
            font-size: 13px;
        }

        .leaflet-popup-tip {
            background: #ffffff;
        }

        .popup-title {
            font-weight: 600;
            color: #2c5282;
            margin-bottom: 10px;
            font-size: 15px;
            border-bottom: 2px solid #3182ce;
            padding-bottom: 8px;
        }

        .popup-row {
            margin: 8px 0;
            display: flex;
            justify-content: space-between;
        }

        .popup-label {
            color: #718096;
            font-weight: 500;
        }

        .popup-value {
            color: #2d3748;
            font-weight: 600;
        }

        @media (max-width: 1024px) {
            #left-panel, #right-panel {
                width: 300px;
            }
        }

        @media (max-width: 768px) {
            #container {
                flex-direction: column;
            }
            #left-panel {
                width: 100%;
                height: 30vh;
                border-right: none;
                border-bottom: 2px solid #cbd5e0;
            }
            #right-panel {
                width: 100%;
                height: 30vh;
                border-left: none;
                border-top: 2px solid #cbd5e0;
            }
            #map {
                height: 40vh;
            }
        }
    </style>
</head>
<body>
    <div id="header">
        <div class="header-left">
            <div class="seal">TX</div>
            <div class="header-title">
                <h1>Tyler Traffic Management System</h1>
                <div class="header-subtitle">City of Tyler, Texas ‚Ä¢ Real-Time Monitoring</div>
            </div>
        </div>
        <div class="controls">
            <button class="btn btn-primary" id="regenBtn">üîÑ Regenerate</button>
            <button class="btn btn-secondary" id="weatherBtn">üå§Ô∏è Weather</button>
        </div>
    </div>

    <div id="container">
        <div id="left-panel">
            <div class="panel-section">
                <h2>Department Filters</h2>
                <div class="dept-filter">
                    <button class="dept-btn active" data-dept="all">All Departments</button>
                    <button class="dept-btn" data-dept="PD">Police Department</button>
                    <button class="dept-btn" data-dept="Fire">Fire Department</button>
                    <button class="dept-btn" data-dept="Traffic">Traffic Division</button>
                    <button class="dept-btn" data-dept="Streets">Streets & Maintenance</button>
                    <button class="dept-btn" data-dept="Engineering">Engineering</button>
                </div>
            </div>

            <div class="panel-section">
                <h2>Weather Conditions</h2>
                <div id="weather-info">
                    <div class="weather-stat">
                        <span>Condition:</span>
                        <span id="weather-condition">Clear</span>
                    </div>
                    <div class="weather-stat">
                        <span>Temperature:</span>
                        <span id="weather-temp">72¬∞F</span>
                    </div>
                    <div class="weather-stat">
                        <span>Traffic Impact:</span>
                        <span id="weather-impact">None</span>
                    </div>
                </div>
            </div>

            <div class="panel-section">
                <h2>Traffic Legend</h2>
                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-color" style="background: #26de81;"></div>
                        <span>Free Flow (0-20%)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #ffd700;"></div>
                        <span>Light Traffic (20-50%)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #ffa502;"></div>
                        <span>Heavy Traffic (50-70%)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #ff4757;"></div>
                        <span>Severe Congestion (70%+)</span>
                    </div>
                </div>
            </div>
        </div>

        <div id="map"></div>

        <div id="right-panel">
            <div class="panel-section">
                <h2>
                    System Statistics
                    <span id="last-update" style="font-size: 10px; color: #718096; font-weight: normal;"></span>
                </h2>
                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="stat-value" id="stat-incidents">0</div>
                        <div class="stat-label">Active Incidents</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="stat-congestion">0%</div>
                        <div class="stat-label">Avg Congestion</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="stat-speed">0</div>
                        <div class="stat-label">Avg Speed (mph)</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="stat-alerts">0</div>
                        <div class="stat-label">Critical Alerts</div>
                    </div>
                </div>
            </div>

            <div class="panel-section" style="flex: 1; display: flex; flex-direction: column; overflow: hidden; padding: 0;">
                <h2 style="padding: 20px; padding-bottom: 10px; margin: 0;">Traffic Reports & Alerts</h2>
                <div id="reports-container"></div>
            </div>
        </div>
    </div>

    <script>
        // Tyler, TX coordinates
        const TYLER_CENTER = [32.3513, -95.3011];
        
        // Initialize map
        const map = L.map('map', {
            center: TYLER_CENTER,
            zoom: 13,
            zoomControl: true
        });

        // Light professional tile layer
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; OpenStreetMap contributors &copy; CARTO',
            subdomains: 'abcd',
            maxZoom: 19
        }).addTo(map);

        // Road network data - segment by segment, coordinates connect
        const roadNetwork = [
            // Broadway Avenue (North-South major corridor)
            {
                corridor: "Broadway Ave",
                segments: [
                    { geometry: [[32.3850, -95.3011], [32.3800, -95.3011]], speed: 45, departments: ["PD", "Traffic"] },
                    { geometry: [[32.3800, -95.3011], [32.3750, -95.3011]], speed: 45, departments: ["PD", "Traffic"] },
                    { geometry: [[32.3750, -95.3011], [32.3700, -95.3011]], speed: 45, departments: ["PD", "Traffic", "Streets"] },
                    { geometry: [[32.3700, -95.3011], [32.3650, -95.3011]], speed: 40, departments: ["PD", "Traffic"] },
                    { geometry: [[32.3650, -95.3011], [32.3600, -95.3011]], speed: 40, departments: ["PD", "Traffic"] },
                    { geometry: [[32.3600, -95.3011], [32.3550, -95.3011]], speed: 35, departments: ["PD", "Traffic", "Engineering"] },
                    { geometry: [[32.3550, -95.3011], [32.3500, -95.3011]], speed: 35, departments: ["PD", "Traffic"] },
                    { geometry: [[32.3500, -95.3011], [32.3450, -95.3011]], speed: 35, departments: ["PD", "Traffic"] },
                    { geometry: [[32.3450, -95.3011], [32.3400, -95.3011]], speed: 35, departments: ["PD", "Traffic", "Streets"] },
                    { geometry: [[32.3400, -95.3011], [32.3350, -95.3011]], speed: 40, departments: ["PD", "Traffic"] },
                    { geometry: [[32.3350, -95.3011], [32.3300, -95.3011]], speed: 40, departments: ["PD", "Traffic"] },
                    { geometry: [[32.3300, -95.3011], [32.3250, -95.3011]], speed: 45, departments: ["PD", "Traffic"] }
                ]
            },
            // Loop 323 (Eastern segment)
            {
                corridor: "Loop 323 East",
                segments: [
                    { geometry: [[32.3650, -95.2650], [32.3600, -95.2700]], speed: 60, departments: ["PD", "Traffic", "Engineering"] },
                    { geometry: [[32.3600, -95.2700], [32.3550, -95.2750]], speed: 60, departments: ["PD", "Traffic"] },
                    { geometry: [[32.3550, -95.2750], [32.3500, -95.2800]], speed: 60, departments: ["PD", "Traffic"] },
                    { geometry: [[32.3500, -95.2800], [32.3450, -95.2850]], speed: 60, departments: ["PD", "Traffic", "Streets"] },
                    { geometry: [[32.3450, -95.2850], [32.3400, -95.2900]], speed: 60, departments: ["PD", "Traffic"] },
                    { geometry: [[32.3400, -95.2900], [32.3350, -95.2950]], speed: 60, departments: ["PD", "Traffic"] },
                    { geometry: [[32.3350, -95.2950], [32.3300, -95.3000]], speed: 60, departments: ["PD", "Traffic", "Engineering"] }
                ]
            },
            // Loop 323 (Southern segment)
            {
                corridor: "Loop 323 South",
                segments: [
                    { geometry: [[32.3300, -95.3000], [32.3250, -95.3050]], speed: 60, departments: ["PD", "Traffic"] },
                    { geometry: [[32.3250, -95.3050], [32.3200, -95.3100]], speed: 60, departments: ["PD", "Traffic", "Streets"] },
                    { geometry: [[32.3200, -95.3100], [32.3150, -95.3150]], speed: 60, departments: ["PD", "Traffic"] },
                    { geometry: [[32.3150, -95.3150], [32.3100, -95.3200]], speed: 60, departments: ["PD", "Traffic"] },
                    { geometry: [[32.3100, -95.3200], [32.3100, -95.3250]], speed: 60, departments: ["PD", "Traffic", "Engineering"] },
                    { geometry: [[32.3100, -95.3250], [32.3100, -95.3300]], speed: 60, departments: ["PD", "Traffic"] }
                ]
            },
            // Loop 323 (Western segment)
            {
                corridor: "Loop 323 West",
                segments: [
                    { geometry: [[32.3100, -95.3300], [32.3150, -95.3350]], speed: 60, departments: ["PD", "Traffic"] },
                    { geometry: [[32.3150, -95.3350], [32.3200, -95.3400]], speed: 60, departments: ["PD", "Traffic", "Streets"] },
                    { geometry: [[32.3200, -95.3400], [32.3250, -95.3450]], speed: 60, departments: ["PD", "Traffic"] },
                    { geometry: [[32.3250, -95.3450], [32.3300, -95.3500]], speed: 60, departments: ["PD", "Traffic"] },
                    { geometry: [[32.3300, -95.3500], [32.3350, -95.3550]], speed: 60, departments: ["PD", "Traffic", "Engineering"] }
                ]
            },
            // Loop 323 (Northern segment)
            {
                corridor: "Loop 323 North",
                segments: [
                    { geometry: [[32.3350, -95.3550], [32.3400, -95.3500]], speed: 60, departments: ["PD", "Traffic"] },
                    { geometry: [[32.3400, -95.3500], [32.3450, -95.3450]], speed: 60, departments: ["PD", "Traffic", "Streets"] },
                    { geometry: [[32.3450, -95.3450], [32.3500, -95.3400]], speed: 60, departments: ["PD", "Traffic"] },
                    { geometry: [[32.3500, -95.3400], [32.3550, -95.3350]], speed: 60, departments: ["PD", "Traffic"] },
                    { geometry: [[32.3550, -95.3350], [32.3600, -95.3300]], speed: 60, departments: ["PD", "Traffic", "Engineering"] },
                    { geometry: [[32.3600, -95.3300], [32.3650, -95.3250]], speed: 60, departments: ["PD", "Traffic"] },
                    { geometry: [[32.3650, -95.3250], [32.3650, -95.3200]], speed: 60, departments: ["PD", "Traffic"] },
                    { geometry: [[32.3650, -95.3200], [32.3650, -95.3150]], speed: 60, departments: ["PD", "Traffic", "Streets"] },
                    { geometry: [[32.3650, -95.3150], [32.3650, -95.3100]], speed: 60, departments: ["PD", "Traffic"] },
                    { geometry: [[32.3650, -95.3100], [32.3650, -95.3050]], speed: 60, departments: ["PD", "Traffic"] },
                    { geometry: [[32.3650, -95.3050], [32.3650, -95.3000]], speed: 60, departments: ["PD", "Traffic", "Engineering"] },
                    { geometry: [[32.3650, -95.3000], [32.3650, -95.2950]], speed: 60, departments: ["PD", "Traffic"] },
                    { geometry: [[32.3650, -95.2950], [32.3650, -95.2900]], speed: 60, departments: ["PD", "Traffic"] },
                    { geometry: [[32.3650, -95.2900], [32.3650, -95.2850]], speed: 60, departments: ["PD", "Traffic", "Streets"] },
                    { geometry: [[32.3650, -95.2850], [32.3650, -95.2800]], speed: 60, departments: ["PD", "Traffic"] },
                    { geometry: [[32.3650, -95.2800], [32.3650, -95.2750]], speed: 60, departments: ["PD", "Traffic"] },
                    { geometry: [[32.3650, -95.2750], [32.3650, -95.2700]], speed: 60, departments: ["PD", "Traffic", "Engineering"] },
                    { geometry: [[32.3650, -95.2700], [32.3650, -95.2650]], speed: 60, departments: ["PD", "Traffic"] }
                ]
            },
            // State Highway 31 (East-West)
            {
                corridor: "State Highway 31 West",
                segments: [
                    { geometry: [[32.3513, -95.3700], [32.3513, -95.3600]], speed: 55, departments: ["PD", "Traffic", "Engineering"] },
                    { geometry: [[32.3513, -95.3600], [32.3513, -95.3500]], speed: 55, departments: ["PD", "Traffic"] },
                    { geometry: [[32.3513, -95.3500], [32.3513, -95.3400]], speed: 55, departments: ["PD", "Traffic", "Streets"] },
                    { geometry: [[32.3513, -95.3400], [32.3513, -95.3300]], speed: 50, departments: ["PD", "Traffic"] },
                    { geometry: [[32.3513, -95.3300], [32.3513, -95.3200]], speed: 45, departments: ["PD", "Traffic", "Engineering"] },
                    { geometry: [[32.3513, -95.3200], [32.3513, -95.3100]], speed: 40, departments: ["PD", "Traffic"] }
                ]
            },
            {
                corridor: "State Highway 31 East",
                segments: [
                    { geometry: [[32.3513, -95.3011], [32.3513, -95.2900]], speed: 40, departments: ["PD", "Traffic"] },
                    { geometry: [[32.3513, -95.2900], [32.3513, -95.2800]], speed: 45, departments: ["PD", "Traffic", "Streets"] },
                    { geometry: [[32.3513, -95.2800], [32.3513, -95.2700]], speed: 50, departments: ["PD", "Traffic", "Engineering"] },
                    { geometry: [[32.3513, -95.2700], [32.3513, -95.2600]], speed: 55, departments: ["PD", "Traffic"] },
                    { geometry: [[32.3513, -95.2600], [32.3513, -95.2500]], speed: 55, departments: ["PD", "Traffic"] }
                ]
            },
            // Cumberland Road
            {
                corridor: "Cumberland Rd",
                segments: [
                    { geometry: [[32.3700, -95.3300], [32.3650, -95.3250]], speed: 45, departments: ["PD", "Traffic", "Streets"] },
                    { geometry: [[32.3650, -95.3250], [32.3600, -95.3200]], speed: 45, departments: ["PD", "Traffic"] },
                    { geometry: [[32.3600, -95.3200], [32.3550, -95.3150]], speed: 45, departments: ["PD", "Traffic"] },
                    { geometry: [[32.3550, -95.3150], [32.3500, -95.3100]], speed: 40, departments: ["PD", "Traffic", "Engineering"] },
                    { geometry: [[32.3500, -95.3100], [32.3450, -95.3050]], speed: 40, departments: ["PD", "Traffic"] },
                    { geometry: [[32.3450, -95.3050], [32.3400, -95.3000]], speed: 35, departments: ["PD", "Traffic", "Streets"] }
                ]
            },
            // Old Jacksonville Highway
            {
                corridor: "Old Jacksonville Hwy",
                segments: [
                    { geometry: [[32.3700, -95.2700], [32.3650, -95.2750]], speed: 50, departments: ["PD", "Traffic"] },
                    { geometry: [[32.3650, -95.2750], [32.3600, -95.2800]], speed: 50, departments: ["PD", "Traffic", "Streets"] },
                    { geometry: [[32.3600, -95.2800], [32.3550, -95.2850]], speed: 50, departments: ["PD", "Traffic"] },
                    { geometry: [[32.3550, -95.2850], [32.3500, -95.2900]], speed: 45, departments: ["PD", "Traffic", "Engineering"] },
                    { geometry: [[32.3500, -95.2900], [32.3450, -95.2950]], speed: 45, departments: ["PD", "Traffic"] },
                    { geometry: [[32.3450, -95.2950], [32.3400, -95.3000]], speed: 40, departments: ["PD", "Traffic", "Streets"] }
                ]
            },
            // Gentry Parkway
            {
                corridor: "Gentry Pkwy",
                segments: [
                    { geometry: [[32.3400, -95.3400], [32.3400, -95.3300]], speed: 45, departments: ["PD", "Traffic", "Engineering"] },
                    { geometry: [[32.3400, -95.3300], [32.3400, -95.3200]], speed: 45, departments: ["PD", "Traffic"] },
                    { geometry: [[32.3400, -95.3200], [32.3400, -95.3100]], speed: 45, departments: ["PD", "Traffic", "Streets"] },
                    { geometry: [[32.3400, -95.3100], [32.3400, -95.3000]], speed: 45, departments: ["PD", "Traffic"] },
                    { geometry: [[32.3400, -95.3000], [32.3400, -95.2900]], speed: 45, departments: ["PD", "Traffic"] },
                    { geometry: [[32.3400, -95.2900], [32.3400, -95.2800]], speed: 45, departments: ["PD", "Traffic", "Engineering"] }
                ]
            },
            // Downtown Grid - Erwin Street (East-West)
            {
                corridor: "Erwin St",
                segments: [
                    { geometry: [[32.3513, -95.3100], [32.3513, -95.3070]], speed: 30, departments: ["PD", "Traffic"] },
                    { geometry: [[32.3513, -95.3070], [32.3513, -95.3040]], speed: 30, departments: ["PD", "Traffic", "Streets"] },
                    { geometry: [[32.3513, -95.3040], [32.3513, -95.3011]], speed: 30, departments: ["PD", "Traffic"] },
                    { geometry: [[32.3513, -95.3011], [32.3513, -95.2980]], speed: 30, departments: ["PD", "Traffic"] },
                    { geometry: [[32.3513, -95.2980], [32.3513, -95.2950]], speed: 30, departments: ["PD", "Traffic", "Engineering"] }
                ]
            },
            // Downtown Grid - Ferguson Street (North-South)
            {
                corridor: "Ferguson St",
                segments: [
                    { geometry: [[32.3580, -95.3011], [32.3560, -95.3011]], speed: 30, departments: ["PD", "Traffic"] },
                    { geometry: [[32.3560, -95.3011], [32.3540, -95.3011]], speed: 30, departments: ["PD", "Traffic", "Streets"] },
                    { geometry: [[32.3540, -95.3011], [32.3520, -95.3011]], speed: 30, departments: ["PD", "Traffic"] },
                    { geometry: [[32.3520, -95.3011], [32.3500, -95.3011]], speed: 30, departments: ["PD", "Traffic"] },
                    { geometry: [[32.3500, -95.3011], [32.3480, -95.3011]], speed: 30, departments: ["PD", "Traffic", "Engineering"] }
                ]
            },
            // South Broadway
            {
                corridor: "S Broadway Ave",
                segments: [
                    { geometry: [[32.3250, -95.3011], [32.3200, -95.3011]], speed: 40, departments: ["PD", "Traffic"] },
                    { geometry: [[32.3200, -95.3011], [32.3150, -95.3011]], speed: 40, departments: ["PD", "Traffic", "Streets"] },
                    { geometry: [[32.3150, -95.3011], [32.3100, -95.3011]], speed: 35, departments: ["PD", "Traffic", "Engineering"] },
                    { geometry: [[32.3100, -95.3011], [32.3050, -95.3011]], speed: 35, departments: ["PD", "Traffic"] }
                ]
            },
            // Front Street
            {
                corridor: "Front St",
                segments: [
                    { geometry: [[32.3530, -95.3100], [32.3530, -95.3070]], speed: 25, departments: ["PD", "Traffic", "Streets"] },
                    { geometry: [[32.3530, -95.3070], [32.3530, -95.3040]], speed: 25, departments: ["PD", "Traffic"] },
                    { geometry: [[32.3530, -95.3040], [32.3530, -95.3011]], speed: 25, departments: ["PD", "Traffic"] },
                    { geometry: [[32.3530, -95.3011], [32.3530, -95.2980]], speed: 25, departments: ["PD", "Traffic", "Engineering"] }
                ]
            },
            // College Avenue
            {
                corridor: "College Ave",
                segments: [
                    { geometry: [[32.3600, -95.3100], [32.3580, -95.3080]], speed: 35, departments: ["PD", "Traffic"] },
                    { geometry: [[32.3580, -95.3080], [32.3560, -95.3060]], speed: 35, departments: ["PD", "Traffic", "Streets"] },
                    { geometry: [[32.3560, -95.3060], [32.3540, -95.3040]], speed: 35, departments: ["PD", "Traffic"] },
                    { geometry: [[32.3540, -95.3040], [32.3520, -95.3020]], speed: 35, departments: ["PD", "Traffic", "Engineering"] },
                    { geometry: [[32.3520, -95.3020], [32.3500, -95.3000]], speed: 35, departments: ["PD", "Traffic"] }
                ]
            },
            // Beckham Avenue
            {
                corridor: "Beckham Ave",
                segments: [
                    { geometry: [[32.3450, -95.3300], [32.3450, -95.3250]], speed: 35, departments: ["PD", "Traffic", "Streets"] },
                    { geometry: [[32.3450, -95.3250], [32.3450, -95.3200]], speed: 35, departments: ["PD", "Traffic"] },
                    { geometry: [[32.3450, -95.3200], [32.3450, -95.3150]], speed: 35, departments: ["PD", "Traffic"] },
                    { geometry: [[32.3450, -95.3150], [32.3450, -95.3100]], speed: 35, departments: ["PD", "Traffic", "Engineering"] },
                    { geometry: [[32.3450, -95.3100], [32.3450, -95.3050]], speed: 35, departments: ["PD", "Traffic"] }
                ]
            },
            // Rice Road
            {
                corridor: "Rice Rd",
                segments: [
                    { geometry: [[32.3300, -95.3400], [32.3300, -95.3350]], speed: 40, departments: ["PD", "Traffic"] },
                    { geometry: [[32.3300, -95.3350], [32.3300, -95.3300]], speed: 40, departments: ["PD", "Traffic", "Streets"] },
                    { geometry: [[32.3300, -95.3300], [32.3300, -95.3250]], speed: 40, departments: ["PD", "Traffic"] },
                    { geometry: [[32.3300, -95.3250], [32.3300, -95.3200]], speed: 40, departments: ["PD", "Traffic", "Engineering"] },
                    { geometry: [[32.3300, -95.3200], [32.3300, -95.3150]], speed: 40, departments: ["PD", "Traffic"] }
                ]
            },
            // Troup Highway
            {
                corridor: "Troup Hwy",
                segments: [
                    { geometry: [[32.3200, -95.3500], [32.3200, -95.3450]], speed: 50, departments: ["PD", "Traffic", "Engineering"] },
                    { geometry: [[32.3200, -95.3450], [32.3200, -95.3400]], speed: 50, departments: ["PD", "Traffic"] },
                    { geometry: [[32.3200, -95.3400], [32.3200, -95.3350]], speed: 50, departments: ["PD", "Traffic", "Streets"] },
                    { geometry: [[32.3200, -95.3350], [32.3200, -95.3300]], speed: 45, departments: ["PD", "Traffic"] },
                    { geometry: [[32.3200, -95.3300], [32.3200, -95.3250]], speed: 45, departments: ["PD", "Traffic"] }
                ]
            },
            // Paluxy Drive
            {
                corridor: "Paluxy Dr",
                segments: [
                    { geometry: [[32.3650, -95.2900], [32.3600, -95.2900]], speed: 40, departments: ["PD", "Traffic"] },
                    { geometry: [[32.3600, -95.2900], [32.3550, -95.2900]], speed: 40, departments: ["PD", "Traffic", "Streets"] },
                    { geometry: [[32.3550, -95.2900], [32.3500, -95.2900]], speed: 40, departments: ["PD", "Traffic"] },
                    { geometry: [[32.3500, -95.2900], [32.3450, -95.2900]], speed: 35, departments: ["PD", "Traffic", "Engineering"] }
                ]
            },
            // Fifth Street
            {
                corridor: "Fifth St",
                segments: [
                    { geometry: [[32.3550, -95.3150], [32.3550, -95.3120]], speed: 30, departments: ["PD", "Traffic", "Streets"] },
                    { geometry: [[32.3550, -95.3120], [32.3550, -95.3090]], speed: 30, departments: ["PD", "Traffic"] },
                    { geometry: [[32.3550, -95.3090], [32.3550, -95.3060]], speed: 30, departments: ["PD", "Traffic"] },
                    { geometry: [[32.3550, -95.3060], [32.3550, -95.3030]], speed: 30, departments: ["PD", "Traffic", "Engineering"] },
                    { geometry: [[32.3550, -95.3030], [32.3550, -95.3000]], speed: 30, departments: ["PD", "Traffic"] }
                ]
            },
            // Old Omen Road
            {
                corridor: "Old Omen Rd",
                segments: [
                    { geometry: [[32.3750, -95.3200], [32.3720, -95.3180]], speed: 45, departments: ["PD", "Traffic"] },
                    { geometry: [[32.3720, -95.3180], [32.3690, -95.3160]], speed: 45, departments: ["PD", "Traffic", "Streets"] },
                    { geometry: [[32.3690, -95.3160], [32.3660, -95.3140]], speed: 45, departments: ["PD", "Traffic"] },
                    { geometry: [[32.3660, -95.3140], [32.3630, -95.3120]], speed: 40, departments: ["PD", "Traffic", "Engineering"] },
                    { geometry: [[32.3630, -95.3120], [32.3600, -95.3100]], speed: 40, departments: ["PD", "Traffic"] }
                ]
            },
            // ESE Loop
            {
                corridor: "ESE Loop",
                segments: [
                    { geometry: [[32.3350, -95.2700], [32.3320, -95.2730]], speed: 55, departments: ["PD", "Traffic", "Engineering"] },
                    { geometry: [[32.3320, -95.2730], [32.3290, -95.2760]], speed: 55, departments: ["PD", "Traffic"] },
                    { geometry: [[32.3290, -95.2760], [32.3260, -95.2790]], speed: 55, departments: ["PD", "Traffic"] },
                    { geometry: [[32.3260, -95.2790], [32.3230, -95.2820]], speed: 55, departments: ["PD", "Traffic", "Streets"] }
                ]
            },
            // Toll Road
            {
                corridor: "Toll Rd",
                segments: [
                    { geometry: [[32.3800, -95.3400], [32.3770, -95.3370]], speed: 65, departments: ["PD", "Traffic", "Engineering"] },
                    { geometry: [[32.3770, -95.3370], [32.3740, -95.3340]], speed: 65, departments: ["PD", "Traffic"] },
                    { geometry: [[32.3740, -95.3340], [32.3710, -95.3310]], speed: 65, departments: ["PD", "Traffic"] },
                    { geometry: [[32.3710, -95.3310], [32.3680, -95.3280]], speed: 65, departments: ["PD", "Traffic", "Streets"] },
                    { geometry: [[32.3680, -95.3280], [32.3650, -95.3250]], speed: 65, departments: ["PD", "Traffic"] }
                ]
            },
            // Grande Boulevard
            {
                corridor: "Grande Blvd",
                segments: [
                    { geometry: [[32.3550, -95.3400], [32.3550, -95.3350]], speed: 40, departments: ["PD", "Traffic"] },
                    { geometry: [[32.3550, -95.3350], [32.3550, -95.3300]], speed: 40, departments: ["PD", "Traffic", "Streets"] },
                    { geometry: [[32.3550, -95.3300], [32.3550, -95.3250]], speed: 40, departments: ["PD", "Traffic"] },
                    { geometry: [[32.3550, -95.3250], [32.3550, -95.3200]], speed: 40, departments: ["PD", "Traffic", "Engineering"] }
                ]
            }
        ];

        // Simulation state
        let simulationState = {
            segments: [],
            reports: [],
            weather: {
                condition: 'Clear',
                temp: 72,
                impact: 'None',
                speedModifier: 1.0
            },
            weatherCircles: []
        };

        let trafficLayers = [];
        let activeDepartments = new Set(['all']);

        // Weather conditions
        const weatherConditions = [
            { condition: 'Clear', temp: 72, impact: 'None', speedModifier: 1.0 },
            { condition: 'Light Rain', temp: 65, impact: 'Minor', speedModifier: 0.9 },
            { condition: 'Heavy Rain', temp: 58, impact: 'Moderate', speedModifier: 0.7 },
            { condition: 'Fog', temp: 68, impact: 'Moderate', speedModifier: 0.75 },
            { condition: 'Thunderstorm', temp: 62, impact: 'Severe', speedModifier: 0.6 },
            { condition: 'Partly Cloudy', temp: 70, impact: 'None', speedModifier: 0.98 },
            { condition: 'Overcast', temp: 66, impact: 'Minor', speedModifier: 0.95 }
        ];

        // Initialize simulation
        function initializeSimulation() {
            // Flatten road network into segments
            simulationState.segments = [];
            roadNetwork.forEach(road => {
                road.segments.forEach((seg, idx) => {
                    simulationState.segments.push({
                        corridor: road.corridor,
                        geometry: seg.geometry,
                        freeFlowSpeed: seg.speed,
                        currentSpeed: seg.speed,
                        departments: seg.departments,
                        confidence: 0.95,
                        segmentId: `${road.corridor}-${idx}`,
                        congestionLevel: 0
                    });
                });
            });

            regenerateSimulation();
        }

        // Regenerate simulation
        function regenerateSimulation() {
            // Update weather randomly
            const weather = weatherConditions[Math.floor(Math.random() * weatherConditions.length)];
            simulationState.weather = weather;
            
            // Clear old weather circles
            simulationState.weatherCircles.forEach(circle => map.removeLayer(circle));
            simulationState.weatherCircles = [];

            // Add weather circles if not clear
            if (weather.condition !== 'Clear' && weather.condition !== 'Partly Cloudy') {
                const numCircles = Math.floor(Math.random() * 3) + 2;
                for (let i = 0; i < numCircles; i++) {
                    const lat = TYLER_CENTER[0] + (Math.random() - 0.5) * 0.15;
                    const lng = TYLER_CENTER[1] + (Math.random() - 0.5) * 0.15;
                    const radius = Math.random() * 2000 + 1000;
                    
                    let color = '#4299e1';
                    if (weather.condition.includes('Thunder')) color = '#f56565';
                    else if (weather.condition.includes('Heavy')) color = '#ed8936';
                    else if (weather.condition.includes('Fog')) color = '#a0aec0';
                    
                    const circle = L.circle([lat, lng], {
                        radius: radius,
                        color: color,
                        fillColor: color,
                        fillOpacity: 0.15,
                        weight: 2,
                        opacity: 0.4
                    }).addTo(map);
                    
                    circle.bindPopup(`<div class="popup-title">NWS/NOAA Weather Alert</div>
                        <div class="popup-row"><span class="popup-label">Condition:</span><span class="popup-value">${weather.condition}</span></div>
                        <div class="popup-row"><span class="popup-label">Radius:</span><span class="popup-value">${(radius/1000).toFixed(1)} km</span></div>
                        <div class="popup-row"><span class="popup-label">Impact:</span><span class="popup-value">${weather.impact}</span></div>`);
                    
                    simulationState.weatherCircles.push(circle);
                }
            }

            // Update UI
            document.getElementById('weather-condition').textContent = weather.condition;
            document.getElementById('weather-temp').textContent = `${weather.temp}¬∞F`;
            document.getElementById('weather-impact').textContent = weather.impact;

            // Simulate traffic conditions
            simulationState.segments.forEach(seg => {
                // Base congestion (random)
                let congestion = Math.random();
                
                // Weather impact
                congestion *= (2 - simulationState.weather.speedModifier);
                
                // Time-based patterns (simulated rush hour)
                const hour = new Date().getHours();
                if ((hour >= 7 && hour <= 9) || (hour >= 16 && hour <= 18)) {
                    congestion *= 1.5;
                }

                // Limit congestion
                congestion = Math.min(congestion, 1);
                
                seg.congestionLevel = congestion;
                seg.currentSpeed = seg.freeFlowSpeed * (1 - congestion * 0.7) * simulationState.weather.speedModifier;
                seg.confidence = 0.85 + Math.random() * 0.15;
            });

            // Generate reports
            generateReports();
            
            // Render traffic
            renderTraffic();
            
            // Update stats
            updateStatistics();
            
            // Update timestamp
            document.getElementById('last-update').textContent = new Date().toLocaleTimeString();
        }

        // Generate traffic reports
        function generateReports() {
            simulationState.reports = [];
            
            const causes = [
                'Vehicle collision',
                'Stalled vehicle',
                'Road construction',
                'Heavy traffic volume',
                'Traffic signal malfunction',
                'Lane closure',
                'Emergency vehicle activity',
                'Disabled vehicle',
                'Road debris',
                'Special event',
                'Weather conditions'
            ];

            const impacts = [
                'Significant delays expected',
                'Lane blocked',
                'All lanes affected',
                'Use alternate route',
                'Expect 10-15 min delays',
                'Minor slowdowns',
                'Traffic backed up 0.5 miles',
                'Reduced speed limit in effect',
                'Right lane closed',
                'Left lane closed'
            ];

            // Select high-congestion segments
            const congestedSegments = simulationState.segments
                .filter(seg => seg.congestionLevel > 0.4)
                .sort((a, b) => b.congestionLevel - a.congestionLevel)
                .slice(0, Math.floor(Math.random() * 8) + 5);

            congestedSegments.forEach((seg, idx) => {
                const severity = seg.congestionLevel > 0.8 ? 'critical' :
                                seg.congestionLevel > 0.6 ? 'high' :
                                seg.congestionLevel > 0.4 ? 'medium' : 'low';
                
                const cause = causes[Math.floor(Math.random() * causes.length)];
                const impact = impacts[Math.floor(Math.random() * impacts.length)];
                
                const startPoint = seg.geometry[0];
                const endPoint = seg.geometry[seg.geometry.length - 1];
                
                const duration = Math.floor(Math.random() * 45) + 15;
                
                simulationState.reports.push({
                    id: `report-${Date.now()}-${idx}`,
                    corridor: seg.corridor,
                    location: `${seg.corridor} near ${startPoint[0].toFixed(4)}, ${startPoint[1].toFixed(4)}`,
                    cause: cause,
                    impact: impact,
                    severity: severity,
                    departments: seg.departments,
                    confidence: seg.confidence,
                    duration: `${duration} min`,
                    timestamp: new Date(),
                    segment: seg
                });
            });

            renderReports();
        }

        // Render reports
        function renderReports() {
            const container = document.getElementById('reports-container');
            container.innerHTML = '';

            simulationState.reports.forEach(report => {
                const card = document.createElement('div');
                card.className = `report-card severity-${report.severity}`;
                
                const timeAgo = Math.floor((new Date() - report.timestamp) / 60000);
                const timeStr = timeAgo === 0 ? 'Just now' : `${timeAgo} min ago`;
                
                card.innerHTML = `
                    <div class="report-header">
                        <div class="report-title">${report.cause}</div>
                        <div class="report-time">${timeStr}</div>
                    </div>
                    <div class="report-location">üìç ${report.corridor}</div>
                    <div class="report-details">${report.impact}</div>
                    <div class="report-meta">
                        <span class="report-badge">‚è±Ô∏è ${report.duration}</span>
                        <span class="report-badge">üéØ ${(report.confidence * 100).toFixed(0)}% confidence</span>
                        <span class="report-badge">üë• ${report.departments.join(', ')}</span>
                    </div>
                `;
                
                card.addEventListener('click', () => {
                    const center = report.segment.geometry[Math.floor(report.segment.geometry.length / 2)];
                    map.setView(center, 15);
                });
                
                container.appendChild(card);
            });
        }

        // Get color based on congestion
        function getCongestionColor(level) {
            if (level < 0.2) return '#26de81';
            if (level < 0.5) return '#ffd700';
            if (level < 0.7) return '#ffa502';
            return '#ff4757';
        }

        // Render traffic on map
        function renderTraffic() {
            // Clear existing layers
            trafficLayers.forEach(layer => map.removeLayer(layer));
            trafficLayers = [];

            simulationState.segments.forEach(seg => {
                // Filter by department
                if (!activeDepartments.has('all')) {
                    if (!seg.departments.some(dept => activeDepartments.has(dept))) {
                        return;
                    }
                }

                const color = getCongestionColor(seg.congestionLevel);
                const weight = 4 + seg.congestionLevel * 4;

                const line = L.polyline(seg.geometry, {
                    color: color,
                    weight: weight,
                    opacity: 0.8,
                    smoothFactor: 1
                }).addTo(map);

                const popupContent = `
                    <div class="popup-title">${seg.corridor}</div>
                    <div class="popup-row">
                        <span class="popup-label">Current Speed:</span>
                        <span class="popup-value">${Math.round(seg.currentSpeed)} mph</span>
                    </div>
                    <div class="popup-row">
                        <span class="popup-label">Free Flow:</span>
                        <span class="popup-value">${seg.freeFlowSpeed} mph</span>
                    </div>
                    <div class="popup-row">
                        <span class="popup-label">Congestion:</span>
                        <span class="popup-value">${(seg.congestionLevel * 100).toFixed(0)}%</span>
                    </div>
                    <div class="popup-row">
                        <span class="popup-label">Departments:</span>
                        <span class="popup-value">${seg.departments.join(', ')}</span>
                    </div>
                    <div class="popup-row">
                        <span class="popup-label">Confidence:</span>
                        <span class="popup-value">${(seg.confidence * 100).toFixed(0)}%</span>
                    </div>
                `;

                line.bindPopup(popupContent);
                trafficLayers.push(line);
            });
        }

        // Update statistics
        function updateStatistics() {
            const totalSegments = simulationState.segments.length;
            const avgCongestion = simulationState.segments.reduce((sum, seg) => sum + seg.congestionLevel, 0) / totalSegments;
            const avgSpeed = simulationState.segments.reduce((sum, seg) => sum + seg.currentSpeed, 0) / totalSegments;
            const criticalAlerts = simulationState.reports.filter(r => r.severity === 'critical').length;

            document.getElementById('stat-incidents').textContent = simulationState.reports.length;
            document.getElementById('stat-congestion').textContent = `${(avgCongestion * 100).toFixed(0)}%`;
            document.getElementById('stat-speed').textContent = Math.round(avgSpeed);
            document.getElementById('stat-alerts').textContent = criticalAlerts;
        }

        // Department filter
        document.querySelectorAll('.dept-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const dept = btn.dataset.dept;
                
                if (dept === 'all') {
                    activeDepartments.clear();
                    activeDepartments.add('all');
                    document.querySelectorAll('.dept-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                } else {
                    activeDepartments.delete('all');
                    document.querySelector('.dept-btn[data-dept="all"]').classList.remove('active');
                    
                    if (activeDepartments.has(dept)) {
                        activeDepartments.delete(dept);
                        btn.classList.remove('active');
                    } else {
                        activeDepartments.add(dept);
                        btn.classList.add('active');
                    }
                    
                    if (activeDepartments.size === 0) {
                        activeDepartments.add('all');
                        document.querySelector('.dept-btn[data-dept="all"]').classList.add('active');
                    }
                }
                
                renderTraffic();
            });
        });

        // Event listeners
        document.getElementById('regenBtn').addEventListener('click', regenerateSimulation);
        document.getElementById('weatherBtn').addEventListener('click', () => {
            const weather = weatherConditions[Math.floor(Math.random() * weatherConditions.length)];
            simulationState.weather = weather;
            regenerateSimulation();
        });

        // Auto-update simulation every 30 seconds
        setInterval(() => {
            regenerateSimulation();
        }, 30000);

        // Initialize
        initializeSimulation();
    </script>
</body>
</html>
